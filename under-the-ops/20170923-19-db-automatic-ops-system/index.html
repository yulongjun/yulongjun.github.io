<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="uA6X_uCQhJlvOqusYftnLIrCAgA25_lWAqRT5YZrnwU" />













  
  
    
  
  <link href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Database,Automatic Ops," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="article">
<meta property="og:title" content="第十九章：数据库自动运维系统">
<meta property="og:url" content="http://www.yulongjun.com/under-the-ops/20170923-19-db-automatic-ops-system/index.html">
<meta property="og:site_name" content="于龙君的博客">
<meta property="og:image" content="http://www.yulongjun.com/images/devops.png">
<meta property="og:image" content="http://www.yulongjun.com/images/15061720041291.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061720979240.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061721339735.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061721782097.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061721936898.jpg">
<meta property="og:updated_time" content="2017-09-23T15:23:53.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第十九章：数据库自动运维系统">
<meta name="twitter:image" content="http://www.yulongjun.com/images/devops.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yulongjun.com/under-the-ops/20170923-19-db-automatic-ops-system/"/>





  <title> 第十九章：数据库自动运维系统 | 于龙君的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-107783004-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e7d6cfa254b42afe3c433690cfa6b887";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">于龙君的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay foolish, stay hungry, and don't be evil.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux">
          <a href="/categories/linux" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            Linux
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/python" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-file-code-o"></i> <br />
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-macos">
          <a href="/categories/macos" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-apple"></i> <br />
            
            macOS
          </a>
        </li>
      
        
        <li class="menu-item menu-item-server">
          <a href="/categories/server" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-server"></i> <br />
            
            服务器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-database">
          <a href="/categories/database" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-database"></i> <br />
            
            数据库
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/categories/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud"></i> <br />
            
            Cloud
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essay">
          <a href="/categories/essay" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-pencil-square"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-under-the-ops">
          <a href="/categories/under-the-ops" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gears"></i> <br />
            
            《运维之下》转载
          </a>
        </li>
      
        
        <li class="menu-item menu-item-donate">
          <a href="/donate" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-credit-card"></i> <br />
            
            赞助
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user-secret"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.yulongjun.com/under-the-ops/20170923-19-db-automatic-ops-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="于龙君">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="于龙君的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                第十九章：数据库自动运维系统
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-23T17:20:38+08:00">
                2017-09-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/under-the-ops/" itemprop="url" rel="index">
                    <span itemprop="name">under-the-ops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/under-the-ops/20170923-19-db-automatic-ops-system/" class="leancloud_visitors" data-flag-title="第十九章：数据库自动运维系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/devops.png" alt="devops"><br><a id="more"></a></p>
<p>在DBA的日常工作中，会有很多重复性的、没有太多技术含量但是又不得不做的事情，比如协调服务器、操作系统环境初始化、部署数据库、添加监控、备份、建立主从复制关系、增减从库、切换主库、上线变更操作等。</p>
<p>这些事情日复一日、年复一年地占用了DBA非常多的时间和精力，以至于只有少量时间，甚至没有时间去做一些更重要的事情，例如参与业务的设计评审、数据库优化、了解数据库底层原理、开发自动化工具等。对于公司来说，这是一种人力资源的浪费；对于DBA团队成员自身发展来说，长期重复这些工作，会感觉到没有收获、没有成长，非常容易产生厌倦、懈怠的情绪。</p>
<p>针对如何提升DBA的工作效率，增加产出质量，我们对DBA的日常工作做了一些分析和总结，如图19-1所示。从服务器上架开始，到数据库服务下线为止，DBA的大部分工作都是重复性的，如果这些事情能由程序自动完成，DBA就可以将更多的精力放在其他更为重要的工作上，而且还能提升操作的正确性和时效性。</p>
<p><img src="/images/15061720041291.jpg" alt=""></p>
<p>图19-1  DBA主要工作细分图</p>
<h2 id="数据库运维发展过程"><a href="#数据库运维发展过程" class="headerlink" title="数据库运维发展过程"></a>数据库运维发展过程</h2><p>我们的自动化运维系统发展经历了三个主要阶段。</p>
<p><strong>（1）先形成点：手动操作过渡到多点半自动</strong><br>在经过一段时间的纯手工操作后，我们开始把其中的一些操作写成简单的Shell脚本，比如用脚本下载源码包、编译安装，并自动设置一部分配置项；这个阶段开发了一系列Shell脚本，每个脚本相对独立地完成各自的工作。DBA在需要时，调用所需的脚本完成不同阶段的操作；抽象地看，就像一个一个的点，各自没有关联。</p>
<p><strong>（2）点连成线：多点半自动过渡到少量半自动流程</strong><br>一系列自动化脚本虽然能有一些帮助，但是由于相互独立，在操作期间还是需要DBA过多地介入其中，等待一个脚本完成后，检查结果，如果正确，再调度下一个脚本。为了继续减少DBA的介入度，我们开始尝试将一些点连接起来，形成线。例如部署完数据库程序后，会自动添加监控和备份任务。不过这个阶段相比上个阶段没有质的变化，只是提高了聚合度，进一步减轻了DBA的工作量。</p>
<p><strong>（3）线形成面：少量半自动流程过渡到自动化系统</strong><br>积累了一定的自动化处理经验后，我们开始尝试把依然是零散的线段变成一个面，形成一套联动的系统。这套自动化系统也是本章重点介绍的内容。</p>
<hr>
<h2 id="设计概述"><a href="#设计概述" class="headerlink" title="设计概述"></a>设计概述</h2><p>在设计数据库自动运维系统的过程中，我们遇到了一些问题和选择，下面简单介绍一下。</p>
<h3 id="数据库集群结构的选择"><a href="#数据库集群结构的选择" class="headerlink" title="数据库集群结构的选择"></a>数据库集群结构的选择</h3><p>目前市场上可见的公有云实现了下面几种数据库集群结构，各种设计都有自己的优点和不足，没有哪个更好，只有适不适合自己的业务场景而已。</p>
<p>◎ <strong>单实例</strong>：只存在一个实例，没有对应的从属实例。这种结构部署和管理起来非常简单，不涉及集群数据一致性问题；不过缺陷也非常突出，严重的单点，一旦宕掉，恢复可能需要比较长的时间，而且可能会丢失大量的数据。这种结构比较适合对服务在线率和数据完整性要求很低的服务，比如测试场景。</p>
<p>◎ <strong>一主一备</strong>：在单实例的基础上，增加了一个备库（隐藏的，业务不可见），可以缓解单点故障对服务稳定度的影响，也能减少数据丢失的风险；但是由于备库是不可见的，不能分担只读请求，所有的读/写压力还是继续由主库承载，存在一定的资源浪费。这种结构比较适合一些读/写量不大的小服务。</p>
<p>◎ <strong>一主一从</strong>：相对于上面的一主一备方案，一主一从方案把备库放到了前台，可以提供给前端业务读取数据使用，避免了备库不能使用的资源浪费。读/写分离可以通过部署数据库Proxy实现，或者提供一个读/写地址和一个只读地址，由应用端自己进行读/写分离。这种结构适用于大部分读/写量都不是很大的小应用。</p>
<p>◎ <strong>一主多从</strong>：对于一些大型服务，特别是读/写比率很高的服务，如果只用一个从库来承载大量的读请求，则有可能导致从库压力过大，复制延迟增大，请求响应时间变长等，因此需要随着读请求的增长不断地增加读副本。由于我们主要面对公司内部服务，且这些服务的数据库请求量（特别是读请求）都是飞速增长的，因此必须支持扩展从库的功能。为了避免单机房故障，我们还需要将多个从库分布在至少两个机房中，保障如果一个机房出现故障，可以快速地恢复服务，继续为广大互联网用户服务。</p>
<h3 id="复制方式"><a href="#复制方式" class="headerlink" title="复制方式"></a>复制方式</h3><p>复制有三种方式，即异步复制（asynchronous replication）、同步复制（synchronous replication）和半同步复制（semi-synchronous replication）。异步复制就是MySQL长期以来默认选择的模式，优点是对主库性能影响最小，但是不能保证主库新增的数据能够及时复制到从库上。</p>
<p>同步复制的数据一致性最强，但是对主库的性能损耗也最多，适合一些宁可牺牲一部分性能，也要保证数据完全一致的场景，比如涉及用户交易数据的业务；对于同步复制感兴趣的读者，可以研究一下采用同步复制机制的Percona XtraDB Cluster。MySQL从5.5版本开始，引入了一种折中的复制方式，即半同步复制，能保证MySQL主库的更新日志（binlog）至少有一个强一致的副本，但MySQL中的数据依然是最终一致的。</p>
<p>半同步机制的数据一致性和性能损耗介于异步和同步两种方式之间。经过综合对比和考虑，我们采用了半同步复制方式，通过牺牲不是太多的性能，换来binlog日志的强一致。</p>
<h3 id="MySQL实例和数据库部署方式的选择"><a href="#MySQL实例和数据库部署方式的选择" class="headerlink" title="MySQL实例和数据库部署方式的选择"></a>MySQL实例和数据库部署方式的选择</h3><p>目前MySQL实例和数据库部署方式只有两种，一种是单实例多库，即在一个MySQL实例中创建多个数据库（database），每个数据库的业务逻辑是独立的。在传统的数据库运维中，这种方式很常见，好处非常明显，减少了运维成本，还可以在一定程度上提升服务器资源利用率；但是缺陷也很明显，不同的库需要维护不同的账号权限，而且非常容易出现资源争抢、同步延迟等问题。</p>
<p>针对单实例多库的情况，MySQL 5.6及以上版本引入了多线程复制，用来缓解一个库的复制延迟导致其他库出现被动延迟的情况。目前原生的MySQL无法对同一个实例中的不同库进行资源的限制和隔离，国内某互联网公司自己修改了MySQL的内核，支持对同实例中的不同库进行独立的资源限制，不过此举代价大，收益小，我们暂不考虑。</p>
<p>另一种是单实例单库，即一个实例中只创建一个数据库，不同业务逻辑的数据库使用不同的MySQL实例。单实例单库的方式可以用较低的成本，监控每个数据库实例的压力、数据增长情况，备份、数据迁移操作不会对其他数据库实例造成影响，对于自动化运维系统来说，这种方式在部署、监控、调度、授权方面都会更加容易实现。</p>
<p>另外，我们在早期制定并推广的《数据库开发规范》中，就强制禁止使用跨库操作（包括跨库事务），所有的读/写操作必须限制在一个库中，程序使用的账号也只授权到一个库，不能有跨库授权，如果对其他数据库也有访问需求，则需要使用另外的数据库访问账号，由程序来进行数据的聚合。有了这个基础，我们才能放心地选择这种部署方式。</p>
<h3 id="资源限制和隔离"><a href="#资源限制和隔离" class="headerlink" title="资源限制和隔离"></a>资源限制和隔离</h3><p>在自动化运维背景下，一台服务器上部署多个数据库实例成为必然，充分地利用服务器硬件资源，减少单服务的运行成本。</p>
<p>多实例部署带来的一个问题是资源争抢。在资源有限的情况下，为了避免共享同一台服务器资源的多个实例间相互影响，需要限制每一个实例所能使用的资源。资源隔离主要有两种方案，一种是传统的虚拟化技术；另一种就是现在发展得如火如荼的Container技术。</p>
<p>两种技术的主要区别如图19-2所示，具体的细节这里就不展开叙述了。总之，Container相比虚拟机来说，更加轻量，资源的损耗也更低，管理起来方便很多。对比了多种方案后，我们选择了Docker。Docker底层是基于LXC技术的，可以有效地控制进程的CPU、内存、IO、网卡流量等资源的使用，并且可以动态调整限制。</p>
<p><img src="/images/15061720979240.jpg" alt=""></p>
<p>图19-2  Container与虚拟机</p>
<h3 id="单版本和多版本的支持"><a href="#单版本和多版本的支持" class="headerlink" title="单版本和多版本的支持"></a>单版本和多版本的支持</h3><p>在自动运维系统中是否要支持多版本？这个问题并没有困扰我们多久，经过简单的内部讨论后，就达成了一致，只提供一个数据库版本，节省了运维成本，也避免了过多的选择对业务开发人员造成困扰。</p>
<h3 id="高可用方案"><a href="#高可用方案" class="headerlink" title="高可用方案"></a>高可用方案</h3><p><strong>（1）主库的高可用</strong><br>在以前的手工运维中，我们一直使用MHA作为主库切换的首选工具（MHA是一个用Perl语言实现的开源数据库主库切换工具，适用于一主多从场景下的切换操作，可以实现故障监测、数据补齐、自动选主等功能），MHA在多次的故障切换（Failover）和在线切换（Online Switch）操作中，保证了切换操作对业务的影响降到最小，减少了切换过程中服务不可写数据库的时间。在长期的使用过程中我们积累了大量的经验，因此在自动运维系统中，我们决定继续采用MHA来辅助完成切换。</p>
<p>在正常方式下，创建一个新的MHA任务，需要先生成一个配置文件，里面记录处于同一个数据库集群的数据库服务器列表和连接信息，然后建立好服务器间的信任关系，最后启动一个守护进程masterha_manager，用来监测主库的存活状态。如果主库出现故障，masterha_manager会自动进行故障切换；或者通过调用在线切换脚本master_ip<em>online</em> change进行在线主库切换。</p>
<p>由于MHA任务的管理改由程序完成，所以我们进行了一些改造。首先增加了一个全局的MHA守护管理模块，用于和自动运维系统进行交互，接收运维系统发送的配置信息和切换命令，并调度MHA进行相关的操作，然后将相关操作结果告诉运维系统。</p>
<p>对于MHA来说，有三点改变。<br>◎ <strong>不提前准备MHA任务配置文件</strong>：数据库集群信息由运维系统管理并维护，在需要进行切换的时候再提供给MHA管理模块，减少了配置文件更新和维护的代价。</p>
<p>◎ <strong>不监测主库的存活</strong>：MHA不再启动守护进程来主动监测主库的存活状态和发起切换动作，是否进行切换和什么时候切换由运维系统来判断和决策。</p>
<p>◎ <strong>不自主选择新主库</strong>：运维系统会根据备选实例的实际运行情况，比如服务器压力情况、所在机房、机架等综合信息，选择出一个新的主库，MHA按照新的主从结构进行切换，如图19-3所示。</p>
<p><img src="/images/15061721339735.jpg" alt=""></p>
<p>图19-3  MHA模块结构图</p>
<p><strong>（2）从库的高可用</strong><br>我们在数据库集群上面加入了代理层Proxy，从库的故障切换就由Proxy完成；Proxy将数据库读请求负载均衡到多个从库上，同时对从库进行存活性检查，及时摘掉失效的从库，避免单从库故障影响正常业务的读请求。</p>
<p><strong>（3）数据库Proxy</strong><br>引入数据库Proxy的主要目的如下。</p>
<p>◎ <strong>统一入口</strong>：屏蔽后端数据库服务结构和变动：数据库集群常常会有调整，比如增/减只读实例，集群扩/缩容，某个实例因为某种原因出现长时间延迟等，这些变动应该对前端服务透明，尽量让用户不感知变化，只要连接到一个地址，就可以使用数据库服务。</p>
<p>◎ <strong>只读流量负载均衡</strong>：当有多于一个的只读实例时，将读请求尽量均匀地分配到每个实例上；如果某个实例所在的服务器压力过大，则可以动态地减少此实例的读请求，由其他实例分摊压力，减少整体服务器的压力。</p>
<p>◎ <strong>用户授权</strong>：用户完成认证后，会发起数据库访问请求，Proxy需要验证用户的身份，如果合法，就授予用户相对应的库表访问权限；否则，拒绝访问。</p>
<p>◎ <strong>流量控制</strong>：如果服务流量突增导致数据库集群（特别是主库）压力过大，无法正常提供服务时，Proxy通过降低并发、延迟转发等服务降级机制，可以缓解后端数据库的压力，避免数据库彻底不可用，使服务完全失效。</p>
<p>◎<strong>访问日志</strong>：类似于MySQL的general log，由于MySQL自身对IO的消耗比较大，且大量的日志会比较消耗磁盘空间，而Proxy服务基本没有IO操作。另外，Proxy作为流量的总入口，日志记录也是最全的，无须再做合并。</p>
<p>◎ <strong>故障重试</strong>：如果后端只读实例宕掉了，在Proxy层将故障实例摘除前，依然会有一部分请求被转发给故障实例，Proxy需要将响应失败的请求，重新发送给其他健康的实例，减少故障影响。</p>
<p>◎<strong>SQL防火墙</strong>：检查将要转发给数据库的SQL，如果不符合预定的规则，则拒绝转发，目的是为了在一定程度上防止拖库，或者防止一些性能有问题的SQL（如全表检索）对数据库造成伤害。<br>数据库Proxy逻辑结构图如图19-4所示。</p>
<p><img src="/images/15061721782097.jpg" alt=""></p>
<p>图19-4  数据库Proxy逻辑结构图</p>
<hr>
<h2 id="系统结构介绍"><a href="#系统结构介绍" class="headerlink" title="系统结构介绍"></a>系统结构介绍</h2><p>通过对数据库服务运行生命周期的分析，我们将自动运维系统分成两个模块来实现，一是部署模块，主要功能是管理服务器集群、安装数据库服务以及相关组件（例如监控、备份程序）；二是数据库实例管理模块，主要功能是管理数据库实例的运行状态、角色变更以及权限管理等。</p>
<p>部署模块不涉及任何数据和状态的维护，实现比较简单，业界也有很多比较好的开源解决方案，经过比较，我们选择了Apache Mesos + Marathon + Docker方案，其他的解决方案还有Kubernetes、Flynn等，大家可以自己去了解，这里不做介绍。</p>
<p>如图19-5所示，应用程序部署工作由Marathon调度Mesos完成，程序运行在Docker容器中。关于Marathon、Mesos和Docker的资料网上有很多，各位读者可以自己去了解。下面重点介绍数据库实例管理模块的设计细节和流程。</p>
<p><img src="/images/15061721936898.jpg" alt=""></p>
<p>图19-5  系统结构示意图</p>
<p>部署模块完成相关的应用程序部署后，会反馈对应的部署信息，比如部署任务（Task）运行在哪些服务器上以及对应的端口、健康检查结果等。数据库实例管理模块以这些信息为基础，开始接手数据库集群的维护工作，主要如下。</p>
<h3 id="选择主实例"><a href="#选择主实例" class="headerlink" title="选择主实例"></a>选择主实例</h3><p>部署模块提供的只有实例的物理信息，对于MySQL集群来说，首先需要选择一个实例作为主库。由于我们使用的服务器集群的硬件配置完全相同，因此选主策略相对简单，目前我们的策略是选择整体资源利用率最低的一台服务器上的实例作为集群主库。后续会考虑加上机柜位置等更加全面的信息，来综合选择一个从物理逻辑上来说更加安全（最少单点）的主库。</p>
<h3 id="建立复制关系"><a href="#建立复制关系" class="headerlink" title="建立复制关系"></a>建立复制关系</h3><p>主库选择好以后，其余实例的角色就确定了，接下来的步骤按部就班：查看主库的binlog偏移量，然后创建具有复制权限的账号，所有从库建立和主库的复制关系，检查同步状态。不过这些步骤是通过代码来自动完成而已。</p>
<h3 id="访问授权"><a href="#访问授权" class="headerlink" title="访问授权"></a>访问授权</h3><p>访问授权分为两层，第一层是MySQL对Proxy层的授权，因为Proxy服务器是明确的，所以比较简单，直接使用MySQL的授权就行。</p>
<p>第二层是Proxy层对业务服务器的授权。连接MySQL时，需要提供对应的用户名和密码，MySQL根据用户名、密码、机器名（IP地址）三元组对请求进行认证，如果认证通过，则提供所需要的数据读/写权限。但是在动态部署环境下，需要访问数据库的业务服务器不能提前确定，而且变动会比较频繁，所以认证过程中的机器名（IP地址）是一个不确定变量。为了提升数据的安全性，需要严格限制能访问数据库的列表，这样机器列表的维护代价比较大；如果为了方便而开通网段级别授权，风险又比较高。</p>
<p>前端开发者在部署服务的时候，肯定知道自己所使用的服务器列表，如果他们能在服务自动部署完成以后，自动将服务器列表注册到一个固定的地方，那么数据库就可以以这个列表为基准进行授权了。</p>
<p>基于这个思想，我们把数据库的认证和授权两个过程进行拆分，建立了一个认证中心，当用户新部署一个服务时，会用提前申请的账号在认证中心注册一些基础信息，部署完服务后，相关服务的元信息就会提交到认证中心。如果服务需要访问数据库，会先通过用户名和密码到认证中心认证自己的身份，如果认证通过，服务会拿到一个唯一的认证码，然后拿着认证码到Proxy请求访问数据库，Proxy拿着认证码到认证中心进行确认，得到确认答复后，Proxy会得到一些关于服务的元信息，Proxy根据这些信息授权服务能够访问哪些数据。</p>
<p>通过这个流程，数据库就不关注服务到底从哪台服务器上发起请求了。可能有些仔细思考的同学会问，如果服务B假冒服务A在认证中心进行注册，意图非法访问服务A的数据怎么办？针对这个问题，我们在服务部署的过程中已经通过类似于身份确认的机制，确保不会出现假冒认证。</p>
<h3 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h3><p>将数据库集群的信息注册到Proxy上，便于Proxy将数据库请求路由到对应的数据库实例上。</p>
<h3 id="添加监控"><a href="#添加监控" class="headerlink" title="添加监控"></a>添加监控</h3><p>数据库实例部署完成后，实例管理系统会自动部署监控Agent，自动将监控数据汇报给监控服务（比如Open-Falcon、Zabbix）。<br>监控数据从操作系统级别和数据库级别进行采集。</p>
<p>操作系统级别：<br>◎ 服务器级别的存活监控：通过Ping等手段检查服务器是否存活。<br>◎ 服务器级别的性能监控：服务器整体的资源使用情况，比如CPU利用率、内存占用率、网卡使用率等；容器级别的资源使用情况。</p>
<p>数据库级别：<br>◎ 数据库存活监控：由专用的监控服务器检测数据库实例是否可以访问；Marathon也会对MySQL实例进行健康检查。<br>◎ 数据库性能监控：数据库内部的运行状态监控，包括但不限于InnoDB引擎数据读/写量、InnoDB锁等待情况、死锁信息；MySQL全局QPS、随机读/写情况等。</p>
<h3 id="添加备份任务"><a href="#添加备份任务" class="headerlink" title="添加备份任务"></a>添加备份任务</h3><p>数据库实例部署完成后，实例管理系统会发送请求给我们基于Xtrabackup开发的一套数据库自动备份系统，建立定期备份任务。</p>
<p>备份系统可以自动完成数据全备、增备、binlog日志备份，还支持自动将数据还原到任意时间点。具体详见下一章内容。</p>
<h3 id="下线"><a href="#下线" class="headerlink" title="下线"></a>下线</h3><p>当数据库集群完成它的使命后，由创建者手动触发集群销毁过程。销毁过程开始后，首先会清理掉LVS上的转发配置，关闭入口，防止再有新的数据库请求，然后关闭数据库实例，并将数据推送到离线备份集群中进行长期保存，最后销毁Proxy和MySQL容器，完成集群的清理。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章对数据库自动运维系统的主要结构和设计思路进行了介绍，通过这套系统，把DBA从日常大量重复的体力劳动中解放出来，让他们有时间去思考更重要的事情。毕竟人是有创造力的，如果精力都困在了那些重复性的体力劳动上，那是对人的不尊重。<br>后续我们会继续完善整个系统的功能，比如在Proxy层加入数据分区功能、开发自动化上线系统等，进一步将人力解放出来。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ღ ღ ღ 如果觉得文章对您有用，不妨打赏一下ღ ღ ღ</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="于龙君 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="于龙君 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      于龙君
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.yulongjun.com/under-the-ops/20170923-19-db-automatic-ops-system/" title="第十九章：数据库自动运维系统">http://www.yulongjun.com/under-the-ops/20170923-19-db-automatic-ops-system/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Database/" rel="tag"># Database</a>
          
            <a href="/tags/Automatic-Ops/" rel="tag"># Automatic Ops</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/under-the-ops/20170923-18-dynamic-scheduling/" rel="next" title="第十八章：动态调度">
                <i class="fa fa-chevron-left"></i> 第十八章：动态调度
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/under-the-ops/20170923-20-db-backup-and-recovery-system/" rel="prev" title="第二十章：数据库备份还原系统">
                第二十章：数据库备份还原系统 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODAzMy80NjA3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="于龙君" />
          <p class="site-author-name" itemprop="name">于龙君</p>
           
              <p class="site-description motion-element" itemprop="description">Linux, Python, macOS</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">224</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">281</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/yu-long-jun" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-quora"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1302333987" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/yulongjun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/__YuLongjun__" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.178linux.com/" title="Linux运维部落" target="_blank">Linux运维部落</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ttlsa.com/" title="运维生存时间" target="_blank">运维生存时间</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.sliverstack.com/" title="李恒的博客" target="_blank">李恒的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.qqlilin.com/" title="李林的博客" target="_blank">李林的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://vinnywang.com/" title="王楠的博客" target="_blank">王楠的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhaodaxin.com/" title="赵大鑫的博客" target="_blank">赵大鑫的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blog.whsir.com/" title="吴昊的博客" target="_blank">吴昊的博客</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库运维发展过程"><span class="nav-number">1.</span> <span class="nav-text">数据库运维发展过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设计概述"><span class="nav-number">2.</span> <span class="nav-text">设计概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库集群结构的选择"><span class="nav-number">2.1.</span> <span class="nav-text">数据库集群结构的选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制方式"><span class="nav-number">2.2.</span> <span class="nav-text">复制方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL实例和数据库部署方式的选择"><span class="nav-number">2.3.</span> <span class="nav-text">MySQL实例和数据库部署方式的选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#资源限制和隔离"><span class="nav-number">2.4.</span> <span class="nav-text">资源限制和隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单版本和多版本的支持"><span class="nav-number">2.5.</span> <span class="nav-text">单版本和多版本的支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高可用方案"><span class="nav-number">2.6.</span> <span class="nav-text">高可用方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统结构介绍"><span class="nav-number">3.</span> <span class="nav-text">系统结构介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选择主实例"><span class="nav-number">3.1.</span> <span class="nav-text">选择主实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建立复制关系"><span class="nav-number">3.2.</span> <span class="nav-text">建立复制关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问授权"><span class="nav-number">3.3.</span> <span class="nav-text">访问授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置代理"><span class="nav-number">3.4.</span> <span class="nav-text">设置代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加监控"><span class="nav-number">3.5.</span> <span class="nav-text">添加监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加备份任务"><span class="nav-number">3.6.</span> <span class="nav-text">添加备份任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下线"><span class="nav-number">3.7.</span> <span class="nav-text">下线</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">于龙君</span>
</div>
<div>
  <a href="http://www.miitbeian.gov.cn/">京ICP备17049401号</a>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("xL6oGKp3T8SyrCjhb93y6RVx-gzGzoHsz", "HGXc2Np0bSets9V1GCOYz0f4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

</body>
</html>
