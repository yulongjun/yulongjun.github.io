<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="uA6X_uCQhJlvOqusYftnLIrCAgA25_lWAqRT5YZrnwU" />













  
  
    
  
  <link href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Deploy System," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="article">
<meta property="og:title" content="第十七章：部署系统">
<meta property="og:url" content="http://www.yulongjun.com/under-the-ops/20170923-17-deploy-system/index.html">
<meta property="og:site_name" content="于龙君的博客">
<meta property="og:image" content="http://www.yulongjun.com/images/devops.png">
<meta property="og:image" content="http://www.yulongjun.com/images/15061702531983.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061703011923.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061703670305.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061704214909.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061704906151.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061706673430.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061708062799.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061708260563.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061708428191.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061708695188.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061709630799.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061710063867.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061710457410.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061710482935.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061711064141.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061711143907.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061711435870.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061711659420.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061711725908.jpg">
<meta property="og:updated_time" content="2017-10-12T14:39:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第十七章：部署系统">
<meta name="twitter:image" content="http://www.yulongjun.com/images/devops.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yulongjun.com/under-the-ops/20170923-17-deploy-system/"/>





  <title> 第十七章：部署系统 | 于龙君的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-107783004-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e7d6cfa254b42afe3c433690cfa6b887";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">于龙君的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay foolish, stay hungry, and don't be evil.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux">
          <a href="/categories/linux" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            Linux
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/python" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-file-code-o"></i> <br />
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-macos">
          <a href="/categories/macos" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-apple"></i> <br />
            
            macOS
          </a>
        </li>
      
        
        <li class="menu-item menu-item-server">
          <a href="/categories/server" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-server"></i> <br />
            
            服务器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-database">
          <a href="/categories/database" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-database"></i> <br />
            
            数据库
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/categories/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud"></i> <br />
            
            Cloud
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essay">
          <a href="/categories/essay" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-pencil-square"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-under-the-ops">
          <a href="/categories/under-the-ops" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gears"></i> <br />
            
            《运维之下》转载
          </a>
        </li>
      
        
        <li class="menu-item menu-item-donate">
          <a href="/donate" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-credit-card"></i> <br />
            
            赞助
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user-secret"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.yulongjun.com/under-the-ops/20170923-17-deploy-system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="于龙君">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="于龙君的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                第十七章：部署系统
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-23T17:19:57+08:00">
                2017-09-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/under-the-ops/" itemprop="url" rel="index">
                    <span itemprop="name">under-the-ops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/under-the-ops/20170923-17-deploy-system/" class="leancloud_visitors" data-flag-title="第十七章：部署系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/devops.png" alt="devops"><br><a id="more"></a></p>
<p>在运维工作中，线上服务所依赖的环境管理、线上服务的发布和回滚是核心工作之一，支撑这部分工作的一个重要系统就是部署系统。</p>
<p>部署系统是保障研发工程师所开发的代码能否顺利、高效地部署到线上，以及保障线上服务能否正确、稳定运行的重要前提，也是保障线上服务具备良好可运维性的重要条件。</p>
<p>如果把研发人员开发的代码比作培育出来的小羔羊，那么部署系统就是保障农场的合理规划、以及像牧羊犬一样能够管理约束羊群的重要工具，如果没有后者，羊群会四散飘散，这样既不利于羊的安全，也不利于牧羊人收放自如地管理羊群。</p>
<p>因此，部署系统是规范线上环境管理、服务发布和变更，以及服务有序管理的重要基础工具。</p>
<hr>
<h2 id="部署系统综述"><a href="#部署系统综述" class="headerlink" title="部署系统综述"></a>部署系统综述</h2><p>互联网公司的项目迭代速度特别快，因此对部署系统的要求除了常规的功能性需求之外，还有高效的要求。在实施自动化部署系统设计、开发和使用推进方面，需要考虑如下几点。</p>
<p><strong>1．在什么阶段开启部署自动化工作</strong><br>在什么阶段开启部署自动化建设，将直接影响部署自动化能够做到的程度和成本。公司早期是各个项目可塑性最强的时候，并且服务还没有上量，是最适宜开启运维自动化工作的阶段。但是大部分公司在创建早期都不会招聘专职的应用运维工程师，而是由系统工程师做基础设施的运维，或者由研发工程师直接维护线上服务。</p>
<p>对此，我们的建议是，前期可以没有很强的平台，但应该制定较强的部署规范，先收敛各类服务需求的多样性，然后借助开源的运维工具进行简单的自动化实施。如果已经错过了公司前期的规范化约束，那么通常后期需要花更多的时间来梳理服务的部署方式和制定推进相关的规范。</p>
<p><strong>2．部署系统的不同阶段的定位是什么</strong><br>在不同的阶段，部署系统关注的需求是不一样的。部署系统前期关注的是如何将线上各类服务管理起来并实现部署动作的自动化，减少手工上线<br>中期关注的是如何将部署系统跟其他运维系统联动，使得部署状态能够自动更新到关联的运维系统，降低人工维护成本<br>后期关注的是如何更好地提升部署的动态化，例如借助资源隔离和动态调度等方法，更好地满足实例混合部署、动态扩容/缩容、动态故障迁移，以及提升服务器资源利用率等需求。</p>
<p><strong>3．设计部署工具时如何预估未来的需求，以及新需求如何支持</strong><br>部署系统除了需要满足当前场景下的需求之外，还需要不断支持新的需求，甚至对未来可能的需求要有一些预估。</p>
<p>对此我们的经验是：一方面，在公司内部建立通畅的需求管理机制，方便使用方快捷提出需求；另一方面，多跟业内其他公司交流，了解其他公司的设计方案和需求情况，来预估未来的需求。此外还有一种比较有效的方法，就是多调研开源的环境管理和部署工具，了解这些工具都满足了哪些需求，都解决了什么问题，借鉴好的设计思想。</p>
<p>运维的很多工作都是需要研发工程师、测试工程师和运维工程师密切配合的，部署工作也不例外。</p>
<p>一方面，线上环境的管理成本、项目迭代的速度等都直接影响着项目上线的时间点，线上服务的稳定性也与开发测试人员息息相关，同时开发人员部署开发环境，测试人员部署测试环境，都会使用到运维自动化的工具</p>
<p>另一方面，部署自动化的推进需要与研发和测试人员密切配合，包括制定发布包的规范、线上路径的规范、配置管理的规范等。</p>
<p>我们的应用运维团队在成立之后立即启动了部署自动化的工作，希望从一开始就将服务部署变更的动作规范起来，避免后期走太多的弯路，期间经历了部署规范的制定、部署系统的开发、与其他关联运维系统整合和全动态部署等不同阶段。</p>
<p>在部署系统发展前期，我们更关注如何将线上百花齐放的服务上线方式集中为统一的方式，这时需要多个规范来约束服务的部署；在部署系统开发设计阶段，更多的是考虑部署系统如何满足运维人员在服务部署各方面的需求，能够满足研发和测试人员的部署需求并提供可靠、方便的使用方式</p>
<p>部署系统全面在线上使用之后，就需要考虑部署系统如何更好地与其他运维系统联动，降低运维管理成本；解决了联动的问题之后，提升资源利用率、动态部署等需求的必要性也随之提升，因此这个阶段需要关注资源隔离和动态调度的需求。下面通过分析不同阶段的工作来串联整个部署自动化的实施过程。</p>
<hr>
<h2 id="部署系统的前置规范"><a href="#部署系统的前置规范" class="headerlink" title="部署系统的前置规范"></a>部署系统的前置规范</h2><p>在手工操作阶段，依托的是流程和人的可靠性。为了减少因人为因素导致出现服务部署错误的情况，必须制定很强的流程规范，例如，要通过流程约束服务部署到线上前的测试过程、约束上线申请中的手工操作步骤和回滚步骤等。</p>
<p>上线的操作环节也要求运维工程师具备丰富的经验，并要求运维工程师按照操作步骤进行上线或回滚，操作的方法基本是逐台进行，这其中包含着较多的重复动作，对于实例数量较多的服务，会带来上线过程烦琐、耗时长等问题。</p>
<p>在这个阶段，很多的运维工程师往往都会通过自己实现的一些小脚本来进行操作，但这些脚本往往会带有一些业务服务相关的逻辑，比较难以做到跨产品迁移，因此我们需要确定相应的规范来配合工具进行服务部署。</p>
<p>对于处在这一阶段的服务，可以通过这样几个规范进行约束：软件依赖管理的规范、编译发布联动的规范、线上目录结构的规范。线上服务满足这几个规范之后，既可以提升服务在人工管理时的清晰度和便利性，也可以为后来的自动化部署实现提供基础。</p>
<h3 id="软件依赖问题的解决"><a href="#软件依赖问题的解决" class="headerlink" title="软件依赖问题的解决"></a>软件依赖问题的解决</h3><p>随着硬件性能的不断提升，为了提高单服务器的资源使用率，我们通常会在单台服务器上部署多个实例。当单机需要部署多个服务实例的时候，每个服务所依赖的软件的版本冲突问题就会突显出来，例如，一台机器上部署了两个Java服务，但使用的Java版本却不相同。如何解决机器上不同服务实例依赖相同软件的不同版本问题，是部署系统必须解决的问题之一。</p>
<p>对于这个问题，原先更多的是通过人工的方式来分隔，也就是将依赖相同软件的服务部署在同一台机器上，依赖有区别的服务只能部署到不同的服务器上，这样虽然可以解决软件依赖冲突的问题，但却增加了管理成本。</p>
<p>在我们的规范中，将服务依赖的所有软件分为两类：基础软件和服务自带软件。基础软件是系统所带的软件，只支持默认版本，不支持定制需求，例如系统自带的JDK 1.6、Python 2.6等（如图17-1所示，基础软件由系统默认提供）。</p>
<p>对于有特殊需求的服务，要求在发布包中自带其所依赖的环境，并将服务配置为依赖自带的软件来启动。如图17-1所示，Nexus服务依赖JDK 1.7，与系统版本不同，就需要在自己的发布包中自带JDK 1.7，而IM服务均使用系统自带的基础软件，因此它不需要自带依赖软件。这个思路类似于Python中的Virtual Env，只是将这个思路应用到各个语言下的各种场景中。</p>
<p><img src="/images/15061702531983.jpg" alt=""></p>
<p>图17-1  服务依赖不同的软件实现示意图</p>
<p>按照上述的规范改造之后，可以解决依赖冲突的问题，并且在后续引入进程管理工具之后，在管理上会非常便捷。这个思路也跟Docker的完全隔离方案一脉相承，在后期引入Docker之后，无须再变更部署方案，可以直接就用上Docker。</p>
<h3 id="编译规范及编译部署的联动"><a href="#编译规范及编译部署的联动" class="headerlink" title="编译规范及编译部署的联动"></a>编译规范及编译部署的联动</h3><p>编译对于服务发布来说是不可或缺的一个环节，通过编译规范可以约束编译出的发布包的结构，从而减轻部署系统处理发布包的复杂程度。</p>
<p>结合线上服务的情况，我们确定了下面所示的源码包和发布包结构规范，其中deploy目录是源码包中必须包含的，该目录下包含着发布时所需的配置文件，在编译环节直接拷贝到发布包中，供部署工具解析使用。源码包中的build脚本是编译时执行的脚本，允许用户定制编译动作，只要是可执行的脚本语言即可。</p>
<p>源码包结构示意如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Service-A</div><div class="line">  |- build</div><div class="line">  |- code_dirs</div><div class="line">  |- other_dirs</div><div class="line">  |- deploy</div><div class="line">    |- 部署配置</div><div class="line">    |- 配置文件模板</div></pre></td></tr></table></figure>
<p>编译后的发布包结构示意如下，deploy目录直接从源码包中拷贝过来，其他目录是项目编译后的产物：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Service-A</div><div class="line">  |- bin</div><div class="line">  |- conf</div><div class="line">  |- other_dirs</div><div class="line">  |- deploy</div><div class="line">    |- 部署配置</div><div class="line">    |- 配置文件模板</div></pre></td></tr></table></figure>
<p>在确定编译环节的规范中，我们既参考了CloudFoundry的buildpack的思路，也考虑到了公司内服务的情况，将buildpack中的detect、compile、release三个脚本合一，使其既能够兼顾较为简单的服务的编译，也能够满足复杂的服务的编译。同时增加了对输出的发布包的目录结构的要求，使得后面的部署系统能够快速对接上。</p>
<p>在确定了编译环节的规范之后，就可以很容易地将编译环节融入到整个服务发布中来。如图17-2所示，进行某个服务的部署，部署系统首先会判断产品库中有没有这个服务指定版本的发布包，如果没有，则走编译系统进行编译，然后发起部署；如果已经存在该版本的发布包，则直接进行部署。</p>
<p><img src="/images/15061703011923.jpg" alt=""></p>
<p>图17-2  编译和部署整体流程</p>
<h3 id="线上目录的规范"><a href="#线上目录的规范" class="headerlink" title="线上目录的规范"></a>线上目录的规范</h3><p>线上目录的规范用于约束服务在线上运行时程序、日志、数据的位置，对在机器上人工查看和管理来说，这个规范非常重要，没有明确的规范会导致线上目录混乱无法管理；对于部署系统来说，明确的目录规范可以降低系统设计的复杂度。目录规范属于制定较简单，但是推动执行却比较烦琐的工作。</p>
<p>制定此规范主要考虑如下三点。<br>（1）目录结构是明确的，并且足够简单，做到工程师不用思考便可找到所需要的目录。<br>（2）程序（含配置）、数据、日志分离，便于进行程序发布更新时不影响数据和日志，同时日志分离出来之后便于定期清理。<br>（3）能够满足某些特殊场景，比如某些服务的数据对读/写要求较高，目录要挂载SSD盘。</p>
<p>经过综合考虑，我们确定的目录规范如下，能够很好地满足线上的各种需求。<br>可执行文件和配置在一个目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/home/work/bin/SERVICE-A</div><div class="line">  |- bin</div><div class="line">  |- conf</div><div class="line">  |- other_dir</div></pre></td></tr></table></figure>
<p>日志文件在独立的目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/home/work/log/SERVICE-A</div><div class="line">  |- xxx.log</div><div class="line">  |- old_log_dir</div></pre></td></tr></table></figure>
<p>数据文件和临时文件在独立的目录下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/home/work/data/SERVICE-A</div><div class="line">  |- service_data1</div><div class="line">  |- service_data2</div></pre></td></tr></table></figure>
<p>按照上述规范改造后的服务，部署需要关注的二进制程序和配置都在/home/work/bin/SERVICE-A目录下，其他目录部署系统可以不关注，减轻了处理服务日志和数据的逻辑。同时日志的清理可以直接在/home/work/log目录下进行，不必为每个服务的日志目录配置单独的清理任务。独立的数据目录既能够满足挂载不同盘的需求，也能够在服务器上持续保留，不受程序更新发布的影响。</p>
<p>部署系统的前置规范是非常重要的环节，将直接影响到部署系统的设计和后期推进的难度。与此同时，线上服务满足这三个规范之后，对前期手动管理或者借助简单的工具进行管理也能极大地降低难度。</p>
<hr>
<h2 id="部署系统设计"><a href="#部署系统设计" class="headerlink" title="部署系统设计"></a>部署系统设计</h2><p>部署系统除了要满足直接的服务部署功能之外，还需要考虑必要的辅助功能，比如，版本的控制，如何确保服务成功启动和正常运行，如何满足服务在不同场景下配置差异的管理，如何进行服务的快速回滚等。</p>
<p>某个单一的开源部署系统很难完全满足公司内这些具体的需求场景，因此我们需要开发适合于自己公司需求场景下的部署系统，并能够在这个框架下来对接公司其他的运维管理系统，甚至是对接测试系统等。</p>
<p>下面先了解我们自研的部署系统结构，然后分析各个组件的细节，来描述部署系统的整体设计思路。</p>
<h3 id="部署系统结构"><a href="#部署系统结构" class="headerlink" title="部署系统结构"></a>部署系统结构</h3><p><img src="/images/15061703670305.jpg" alt=""></p>
<p>图17-3  部署系统整体结构示意图</p>
<p>如图17-3是我们自研的部署系统的整体结构示意图。Git为公司统一的代码仓库；Build Server接收部署Web端的指令，执行指定服务的某个版本的编译动作，并将编译结果写入产品库中，如果指定的版本已经编译过，则编译动作不会重复执行，返回成功。</p>
<p>Odin是整个部署系统的控制中心，负责解析Web端传过来的部署任务，并调度需要被部署的服务器上的Frigga执行部署动作。Frigga是每台服务器上的Super Agent，负责管理服务器上其他所有的Agent，并提供对外的RPC接口，接收控制端对服务器的操作指令。</p>
<p><strong>整体的部署流程如下：</strong></p>
<p>（1）在Web端选择要部署的服务名称、版本号，以及需要部署的服务器列表。<br>（2）Web端发起编译部署动作，调用Build Server进行编译。<br>（3）编译成功后，Web端调用Odin执行部署任务。<br>（4）Odin控制服务器上的Frigga执行部署动作。</p>
<p><strong>部署系统涉及的组件如下：</strong></p>
<p><strong>1．Odin</strong></p>
<p>Odin是具体部署动作的控制中心，其接收的参数包括本次部署的服务名称、服务器列表、发布包的地址，以及本次发布的流程控制参数（例如，部署任务串并发度控制、部署多少个实例之后需要暂停、每个实例部署完成后需要等待多长时间再进行下一个实例的部署等）。Odin会根据流程控制参数分别调用每台服务器上的RPC接口触发具体的部署动作，并周期性地探测和更新部署进度。</p>
<p>为了能够做到开发、测试和线上环境的部署行为一致，除了要求使用同一套部署系统来进行部署之外，还需要保证任意发起的部署任务都能够被正确地记录状态。为此，我们将所有的状态上报放在了各台服务器上，由Agent来完成，从而减轻了中心端的复杂度，并降低了对中心端的强依赖。这样Odin需要处理的需求就是部署串并发度等流程控制，Odin可以设计得很轻量化，我们也确实将Odin设计为一个脚本程序，可以很方便地在任意地方发起部署。</p>
<p><strong>2．Build Server</strong></p>
<p>Build Server接收Web端发起的编译请求，所需要的参数包括服务名称、Git地址、Git版本号，Build Server会判断对应的版本是否已经编译过，如果曾经编译过，则直接返回成功，并给出发布包的源地址；如果没有编译过，则执行编译过程，将发布包上传到产品库中，然后返回包地址给Web端。</p>
<p><strong>3．Web</strong></p>
<p>部署系统的Web端，是为了更方便地发起部署任务而开发的，Web端将页面部署配置翻译成Odin的配置，并调用Odin进行部署。对部署系统没有扩展性需求的项目一般都是通过Web发起部署的。Web是引导和限制用户规范性操作的一个重要入口，Web的设计原则是：只需填写必要、简单的配置项即可发起任务。</p>
<p><strong>4．部署Agent</strong></p>
<p>服务器上与部署相关的Agent有Frigga、Thor、God，其中Frigga提供RPC服务，Thor是执行具体部署动作的脚本，God是进程守护工具。<br>Frigga并不是专门为部署系统设计的，而是服务器上的Super Agent，在部署中，Frigga接收Odin的部署指令，并调用Thor执行具体的部署动作，而后接收Odin的部署状态查询指令，返回部署进度。</p>
<p>每次部署服务时，每台服务器上需要具体执行的部署工作由Thor负责，包括发布包的下载、服务目录环境初始化、配置文件生成、目录备份等，完成部署工作后调用God来守护服务的运行状态。</p>
<p>God是一个开源的进程守护工具，是每台服务器上所有服务的Supervisor。它的职责就是维护服务器上所有服务的状态，对于已经启动的服务确保其永远处于running状态，如果服务进程意外退出，它会负责将其重新启动。</p>
<p>接下来，我们详细介绍各个组件的实现。</p>
<h3 id="部署系统组件"><a href="#部署系统组件" class="headerlink" title="部署系统组件"></a>部署系统组件</h3><p><strong>1．部署控制中心——Odin</strong></p>
<p>Odin是每次部署任务的控制中心，形态上它是一个脚本，之所以设计成脚本，是因为在整个部署系统中，状态维护和上报的工作交给了服务器上的Agent，中心端无须再花费更多的精力来记录和维护任务状态，即减轻了中心端的复杂程度。</p>
<p>服务状态的维护管理由每台服务器上的Agent负责，能够确保服务状态信息的准确性，并直接与关联的系统进行交互，避免其他运维系统对部署中心端的强依赖。<br>Odin执行部署任务的流程如图17-4所示。</p>
<p><img src="/images/15061704214909.jpg" alt=""></p>
<p>图17-4  Odin执行部署任务的流程图</p>
<p><strong>（1）部署配置</strong></p>
<p>无论是命令行发起任务还是Web端发起任务，最终都是通过执行odin –f cluster.yml来调用Odin执行部署任务的。所有部署的相关配置都在cluster.yml中指定，下面是详细的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">### 本次任务的公共配置</div><div class="line">cluster:</div><div class="line">  ### 本次任务名称</div><div class="line">  name: cop.xiaomi_owt.miliao_pdl.com</div><div class="line">  ### 本次任务id</div><div class="line">  version: 102315</div><div class="line">  ### 本次任务部署的环境</div><div class="line">  env: production-a</div><div class="line">  ### 本次任务包含哪些job，一次任务可以部署多个job，job可以分布在不同服务器上</div><div class="line">  jobs:</div><div class="line">    - job.a_service.A_cluster.production-a_pdl.com_owt.miliao_cop.xiaomi</div><div class="line"> </div><div class="line">### 第一个job的详细配置</div><div class="line">job.a_service.A_cluster.production-a_pdl.com_owt.miliao_cop.xiaomi:</div><div class="line">  ### job a部署的服务器列表</div><div class="line">  host:</div><div class="line">    - a-com-x00.bj</div><div class="line">    - a-com-x01.bj</div><div class="line">  ### job a的启动账号</div><div class="line">  user: work</div><div class="line">  ### job a的并发度</div><div class="line">  multi: 1</div><div class="line">  ### 部署多少台机器后暂停：默认的第一批次机器部署完成后会暂停，然后部署多少台机器后暂停就按下面的配置，0表示不暂停</div><div class="line">  step: 0</div><div class="line">  ### 每一批次机器部署完成后，暂停时间，对于必须控制部署间隔的任务可以配置此项</div><div class="line">  sleep: 10</div><div class="line">  ### job a的版本号</div><div class="line">  version: b3ec8dbbd</div><div class="line">  ### job a的部署路径</div><div class="line">  path: /home/work/bin/a</div><div class="line">  ### 部署动作，restart表示需要重启服务，reload表示直接重载服务，update表示只更新文件，无须重启或者重载服务</div><div class="line">  action: restart</div><div class="line">  ### 包路径，可以是build完成后的包上传的位置，也可以是本地路径</div><div class="line">  pkg_url: http://scm.pt.xiaomi.com/service.A_cluster. production-a _pdl.com_owt.miliao_cop.xiaomi/job.a_b3ec8dbbd.tar.gz</div></pre></td></tr></table></figure>
<p>Odin的配置可以由部署Web生成，也可以手动维护（比如开发环境的部署）。对于已经实施持续部署的服务，可以由持续部署工具来生成cluster.yml，并通过Odin命令行发起部署。</p>
<p><strong>（2）发布包下载</strong></p>
<p>下载发布包有两种方案可选：由服务器上的部署Agent直接去所配置的地址（cluster.yml中的pkg_url配置项）下载，或者Odin从pkg_url下载，并启动下载服务供各台服务器上的Agent进行下载。我们采用的是第二种方案，原因有两个：一是对于很多本地发起的部署任务，编译包无须上传到产品库，而是本地编译直接本地发起部署，Odin提供下载服务，可以避免使用方去解决包下载服务的问题；二是如果各个Agent都从产品库下载的话，产品库的压力会无法预估，由Odin来提供，可以根据部署的具体情况评估下载压力，更好地提供下载服务。</p>
<p><strong>（3）部署并发度控制</strong></p>
<p>不同的任务在进行部署的时候会有不同的并发控制，例如，对于服务器量大、影响小的部署任务需要进行快速部署，而对于实例启停对整个集群有中断影响的重要服务需要逐台进行。因此，我们支持配置部署任务的并发度、暂停点和批次间停留时间。通过配置并发度可以控制每批次部署的服务器数量，配置部署暂停点用来控制部署多少台服务器后暂停，方便工程师介入进行检查，批次间停留时间主要提供给启动时间较长的服务，允许每批次机器部署完成后，停留一段时间，待服务完全启动后再部署下一批次。</p>
<p><strong>（4）触发部署和查询部署结果</strong><br>Odin触发部署动作、查询部署状态都是通过Frigga提供的RPC接口进行的，Odin调用Frigga的startdeploy接口触发Frigga启动部署动作，并拿到返回的任务id，然后周期性地调用Frigga的查询接口查询部署进展，部署完成后，Odin可以通过Frigga的getdeploylog接口拿到本次部署的详细日志，便于用户了解整个部署细节。</p>
<p>Odin的设计思想是在任意时间、任意服务器上均可以发起部署任务，包括命令行发起和Web端发起等。</p>
<p><strong>2．服务器上的Super Agent——Frigga</strong><br>出于安全考虑，服务器上开放的任何接口，都需要进行管理。为了减轻服务器上各个Agent的安全防护成本，我们只允许Frigga提供对外交互，其他Agent不允许开放接口与外界直接交互，如果有需求必须通过Frigga进行代理，这样只需要在Frigga上做好安全防护即可，其他的Agent无须关心。另外，Frigga还承担服务器上管理其他Agent的职责，Agent的部署、升级等都通过Frigga进行控制。、</p>
<p>具体到部署任务，Frigga接收Odin的任务调度后，调用Thor执行单机的部署动作，每一次部署任务，Frigga都会生成唯一的部署任务id，并在本地实时记录部署进度，Odin可以通过这个id查询任务进度和部署日志。</p>
<p><strong>3．部署执行工具——Thor</strong><br>Thor是真正执行部署动作的工具，它接收的配置与Odin相同，不同的是Thor只关注需要在本机上部署的任务，其他的任务会被忽略。Frigga接收部署指令后，会调用Thor执行本机的服务部署动作，包括解析部署配置、下载对应版本的发布包、在临时目录下准备要部署的服务环境、备份并停止待升级的服务、同步发布包内容到指定目录、重新启动服务等一系列操作。Thor执行部署动作的流程如图17-5所示。</p>
<p><img src="/images/15061704906151.jpg" alt=""></p>
<p>图17-5  Thor执行部署动作的流程图</p>
<p>之所以将执行具体部署动作的模块独立出来，还有一个考虑就是，对于有些没有意愿使用部署系统部署自己的开发环境的开发人员，或者服务器是独立在外的（例如CDN机器与IDC内网不通），或者有些公网的机器考虑到安全风险无法开启对外接口的，可以独立使用Thor进行部署。</p>
<p>在第一阶段的规范要求中，我们要求在源码库中放置一个deploy目录，其下面放置的是部署配置，并要求deploy目录在编译环节被放入发布包中，供服务在各台服务器上部署的时候使用。这部分配置是如何约定的？如何来满足各种不同的需求呢？下面我们来详细分析。</p>
<p>在具体的服务部署执行环节（获取发布包后，执行部署动作，生成线上可运行的最终环境），我们需要关注的是服务的软件依赖环境、程序文件、配置文件等，如何按需生成服务的依赖环境，如何正确放置二进制程序，如何按照服务的运行场景生成服务的配置，以及如何处理服务依赖的数据文件。</p>
<p>在这一环节，部分开源软件（如Capistrano）的做法是提供特定的部署动作模板，或者提供批量功能，方便用户自行描述部署时执行的动作（例如，通过自己编写的bash脚本）。提供特定模板的方式虽然稳定性更好，但灵活性不够，无法满足多样化的需求；而用户自行描述部署动作的方式，灵活性够了，但是稳定性不足。</p>
<p>出于多样复杂的部署动作考虑，在不重复造轮子的情况下，我们选择Puppet来解决部署执行问题。在这里我们并没有使用Puppet常规的Master/Slave模式，而是使用它的Apply模式在本地解析Puppet配置文件做动作执行。</p>
<p><strong>使用Puppet Apply来实现具体部署动作执行的原因有三个</strong>：Puppet的DSL（Domain Specific Language）足够优秀，可以约束部署时具体的执行动作，能够保证部署动作描述的准确性；利用Puppet的DSL，能够保证每个部署动作描述和执行的准确性，相比自由编写脚本的方式，更加统一可控；Puppet属于优秀的配置管理软件，业界使用比较广泛，而且运维人员也比较熟悉，学习成本很低。</p>
<p><strong>下面介绍如何通过Puppet解决部署执行环节的几类需求。</strong></p>
<p><strong>（1）满足服务在不同场景下配置不同的方案</strong><br>在服务正式发布到线上环境之前，会有开发环境、Staging测试、Preview环境，每个环境中配置文件里面的参数是不同的，例如，数据库的账号密码在测试环境和线上环境中不同，ZooKeeper地址差异等。这类的配置差异，我们是通过模板和模板值的方式来管理的，具体的替换操作是借助Puppet所提供的erb模板来实现的。通过这种方式，可以减少配置差异性，最终降低线上配置错误的风险。</p>
<p>引入Puppet的模板之后，源码库中deploy目录下的配置详细如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SERVICE-A</div><div class="line">  |- build.sh</div><div class="line">  |- code_dirs</div><div class="line">  |- other_dirs</div><div class="line">  |- deploy</div><div class="line">      |- manifests</div><div class="line">         |- init.pp</div><div class="line">         |- config.pp</div><div class="line">      | - templates</div><div class="line">         |- service.conf.erb</div><div class="line">         |- cron.erb</div></pre></td></tr></table></figure>
<p>在Manifests中，需要配置两个文件：init.pp和config.pp。在config.pp中定义不同场景下的配置模板值，init.pp描述部署执行的动作，包括哪些配置模板需要被替换，在templates下放置配置模板文件。例如，某服务的数据库连接配置，模板文件描述如下：</p>
<p><code>service.conf.erb</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">DB_config:</div><div class="line">  user: &lt;%= scope.lookupvar(＂config::db_config_user＂) %&gt;</div><div class="line">  host: &lt;%= scope.lookupvar(＂config::db_config_host＂) %&gt;</div><div class="line">在config.pp中定义不同场景下的不同配置：</div><div class="line">Config.pp</div><div class="line">class base &#123;</div><div class="line">  $basedir = “/home/work/bin/$jobname”</div><div class="line">  $db_config_host = “127.0.0.1”</div><div class="line">  $db_config_user = “root”</div><div class="line">&#125;</div><div class="line">class staging inherits base &#123;</div><div class="line">&#125;</div><div class="line">class production inherits base&#123;</div><div class="line">  $db_config_host = “10.x.x.x”</div><div class="line">  $db_config_user = “service_user”</div><div class="line">&#125;</div><div class="line">class preview inherits production &#123;</div><div class="line">  $db_config_host = “10.1.x.x”</div><div class="line">&#125;</div><div class="line">class config inherits $&lt;env&gt; &#123;&#125;</div></pre></td></tr></table></figure>
<p>在config.pp中定义模板值，利用Puppet中class及class继承的特性。如上配置所述，我们定义了5个class，分别为base、staging、production、 preview和config，除base和config两个class之外，其他几个class分别对应了不同的部署场景，其中名为base的class是默认配置，在staging的class中继承了base的class，即staging环境中直接使用了默认配置，无须修改；在production的class中继承了base，并对db_config_host和db_config_user进行了重新赋值；在preview的class中继承了production的配置，只修改了db_config_host。最后一句配置“class config inherits $<env>”中的env由部署系统赋值，代表的是本次部署的场景（例如部署staging场景的服务，env=staging），这句的含义是通过一个固定名为config的class继承本次部署的场景对应的class，最终部署使用的配置就是config对应的class中的变量。</env></p>
<p>定义了模板和模板值之后，就可以在init.pp中使用模板替换功能了。</p>
<p><code>init.pp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">class xbox &#123;</div><div class="line">  include config</div><div class="line"> </div><div class="line">  file &#123; ＂$&#123;config::basedir&#125;/conf/service.conf＂:</div><div class="line">    content =&gt; template(＂service.conf.erb＂),</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">include xbox</div></pre></td></tr></table></figure>
<p>其中“include config”即表示引入了之前在config.pp中定义的config这个class，按照前述，此class中定义的就是本次部署场景下的模板值配置。引入config之后，后面的file描述的就是需要替换的服务配置文件，其中file路径中用到的config::basedir和模板文件中的变量都是出自config.pp中定义的config这个class，也就是对应场景的配置。</p>
<p><strong>（2）解决环境依赖的方法</strong></p>
<p>在前述的第一阶段描述的规范中，限定了服务所依赖的软件如何管理的问题，我们要求在编译环节就将服务所依赖的软件同时打包到发布包中，并在服务启动时明确指定使用包中的软件。这一规范能够满足绝大部分场景，但是如果所依赖的包较为复杂，或者软件包过大不适宜直接放在发布包中，就需要借助其他的方法来支持。在我们的部署系统中，是通过在Puppet中实现自定义的provider来做到的。</p>
<p>对于最为复杂的一种情况，即依赖的软件包也要根据不同场景变更配置，或者其他必须借助部署系统来发布的情况，但是软件自身又不是一个真正的服务，我们在Puppet中增加了自己实现的资源，名称为thor（此处的thor是我们自己实现的一种Puppet资源的名称，实现上直接使用了服务器上的部署组件Thor，因此也取名为Thor）。Thor是通过Puppet定义了一个provider资源，这个provider资源的功能是调用本地的部署工具Thor进行服务部署，在一个部署动作描述文件里面引入了其他的部署动作描述，解决部署依赖问题。</p>
<p>举例如下：<br><code>init.pp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">class xbox &#123;</div><div class="line">  include config</div><div class="line"> </div><div class="line">  thor &#123; ＂$&#123;config::basedir&#125;/resin＂:</div><div class="line">    ensure =&gt; present,</div><div class="line">    source =&gt; ＂puppet-resin-4.x.xx.yaml＂,</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">include xbox</div></pre></td></tr></table></figure>
<p>上面init.pp配置文件中，描述了XBOX这个服务部署前需要依赖Resin 4.x.xx服务环境，通过增加Thor这个provider字段，描述了Resin的部署动作。部署系统在进行XBOX服务部署前，Puppet会先检查指定目录下Resin及版本是否正确，如果不正确先进行Resin的部署；确定Resin部署正确后，会进行XBOX服务自身的部署。通过Puppet提供的provider功能实现部署依赖描述，从而解决了服务启动前所需的依赖环境问题。</p>
<p><strong>4．进程守护工具——God</strong></p>
<p>为了保证线上服务在服务器上不间断地运行，通常需要借助一些方法或工具，例如，前台运行的服务需要常驻内存执行的话，可以使用nohup将其放到后台执行，通过输入/输出重定向来处理屏幕的输入和输出，使服务能够在后台运行。</p>
<p>很多的开源软件自身已经实现了Daemon化，例如Nginx、Resin等默认就是Daemon方式启动的，并且主进程还具备了简单的守护功能，在发现子进程挂掉之后会重新拉起子进程，但主进程异常退出后无法自恢复。为了确保各类服务能够持续不间断地运行，我们需要进行服务进程守护管理，同时还希望支持服务重启报警、服务统一启停接口、服务运行状态查询等运维需求。下面介绍几类相关的进程守护的方法或工具，重点介绍我们用God做进程守护的使用经验。</p>
<p>早期，在没有进程守护工具的情况下，为了保障线上服务挂掉之后能够修复，部分工程师想到了使用cron定时执行一个脚本来判断服务是否运行，发现服务进程不在之后尝试重启服务。这是一种比较笨重的方法，维护成本较高，且依托于工程师实现脚本的思维缜密程度，容易出错。</p>
<p>后来经过调研我们使用了Supervisord，它是用Python实现的一个进程守护工具，能够管理非Daemon服务，并在服务挂掉之后进行重启。虽然Supervisord能够满足绝大多数场景下的进程守护需求，但由于当时Supervisord无法管理Daemon服务，以及Supervisord升级时被守护的服务进程会重启等问题，无法完全满足我们对于服务进程守护的需求。</p>
<p>在进一步调研后，我们选择了God这个开源的进程守护工具。God是Ruby实现的一个可配置、可扩展的服务守护框架，能够满足进程守护的基本功能，能够管理Daemon或非Deamon服务，提供统一的服务启停接口。另外，God支持插件功能，比如我们添加了服务状态汇报插件，在服务完成部署后，God能够定时给服务树上报服务部署和运行状态（上报的信息描述示例：服务器A上部署了Nginx 1.5.2，Nginx当前处于running状态）。</p>
<p>整体来看，God包括一个Server端（常驻内存）和一个Client端（命令行工具）。日常的操作都通过Client这个命令行工具来完成，Client通过UNIX Domain Socket将指令发给Server端，由Server完成相关动作。Server端包含一个管理线程（Manager）和若干Worker线程，Manager对于其管理的每一个服务，都会启动一个独立的Worker线程进行管理，Manager和Worker线程之间通过消息队列进行通信，所有动作异步执行。</p>
<p>God通过pid的方式判断守护进程是否存活，这样做的好处是God与所守护的进程解耦，即使God异常退出或升级也不会影响其所守护的服务进程。当God重启后，扫描之前记录的pid文件，继续接管进程的守护工作。God的这些特性也是我们选择使用它的重要原因，能够使我们很方便地对它进行升级，而且不会对线上服务造成影响。</p>
<p>God守护进程时执行的操作均来自于一个消息队列，队列中的event产生的方式有两种：Client触发的动作会产生event，服务状态切换时也会产生event。God支持在各类event上添加回调，执行指定的动作。例如执行god load服务配置时，God接收到load事件，加载指定的配置文件，开始管理指定的服务；执行god start服务时，God接收到start事件，启动服务，并开始守护服务；执行god stop服务时，God接收到stop事件，停止服务，并停止守护。</p>
<p>我们在God默认的机制基础上，增加了reload和nuke两个动作，reload可以满足部分服务的重载需求（比如Nginx）；nuke是对God原生的remove动作的升级，支持完整的服务停止和环境清理工作。</p>
<p>God的灵活状态切换和自定义动作支持功能，在后续部署系统的扩展中发挥了极其重要的作用，我们会在后面详细讲解。<br>God进程守护的整体机制示意图如图17-6所示。</p>
<p><img src="/images/15061706673430.jpg" alt=""></p>
<p>图17-6  God进程守护的整体机制示意图</p>
<p>一个典型的God管理的服务配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">God.watch do |w|</div><div class="line">  ### 加载配置时是否直接启动服务</div><div class="line">  w.autostart = true</div><div class="line">  ### 优雅启动和停止的sleep时间</div><div class="line">  w.grace = 1</div><div class="line">  ### 服务版本</div><div class="line">  w.ver = ＂0c5bbe42c＂</div><div class="line">  ### 服务名称，是God管理服务的名字标识</div><div class="line">  w.name = ＂job.nginx_service.scribe_cluster.production-lg_pdl.account_owt.miliao_cop.xiaomi＂</div><div class="line">  ### uid和gid指定服务启动的账号</div><div class="line">  w.uid = ＂work＂</div><div class="line">  w.gid = ＂work＂</div><div class="line">  ### 服务实例的启动命令</div><div class="line">  w.start = ＂exec /home/work/bin/scribe/bin/scribed -c /home/work/bin/scribe/conf/job.nginx_service.scribe_cluster.production-lg_pdl.account_owt.miliao_cop.xiaomi_scribe.conf 2&gt;&amp;1 ＂</div><div class="line">  ### 标准输出，错误输出的filename</div><div class="line">  w.log = ＂/home/work/log/scribe/run.log＂</div><div class="line">  ### 服务日志文件，便于god log查看</div><div class="line">  w.process_log = [＂/home/work/log/scribe/run.log＂]</div><div class="line">  ### 服务启动的current dir</div><div class="line">w.dir = ＂/home/work/bin/scribe/＂</div><div class="line">### 服务启动的环境变量，对于服务自带的runtime环境，可以在这里指定</div><div class="line">  w.env = &#123;“PATH”: “/bin”&#125;</div><div class="line">  ### 可以限定服务可使用的资源，在我们的场景下用不上</div><div class="line">  w.keepalive(   )</div><div class="line">  ### 服务所带的定时任务，这个功能是我们内部加上的，暂未开源</div><div class="line">  w.cron = ＂/etc/god_cron.d/job.nginx_service.scribe_cluster.production-lg_pdl.account_owt.miliao_cop.xiaomi.cron＂</div><div class="line">  ### 定制nuke时的动作，清理定时任务</div><div class="line">  w.behavior(:change_cron)</div><div class="line">  ### 定制stop时的动作，清理pid文件</div><div class="line">  w.behavior(:clean_pid_file)</div><div class="line">  ### 设置停止时，God等待的超时时间</div><div class="line">  w.stop_timeout = 300.seconds</div><div class="line">  ### 定义God发现服务宕掉之后的重启规则</div><div class="line">  w.lifecycle do |on|</div><div class="line">    on.condition(:flapping) do |c|</div><div class="line">      c.to_state = [:start, :restart]</div><div class="line">      c.times = 6</div><div class="line">      c.within = 10.minute</div><div class="line">      c.transition = :unmonitored</div><div class="line">      c.retry_times = 200000</div><div class="line">      c.retry_within = 1.hours</div><div class="line">      c.notify = &apos;proc_down&apos;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div><div class="line">### 定义God重启服务失败后的通知规则</div><div class="line">God.contact(:email) do |c|</div><div class="line">  c.name = &apos;proc_down&apos;</div><div class="line">  c.group = &apos;developers&apos; </div><div class="line">  c.to_email = ＂x@xiaomi.com＂</div><div class="line">end</div></pre></td></tr></table></figure>
<p>可以看到God的配置是Ruby代码，这样可以使得配置的含义更加明确，同时更加灵活。当然，因为这种配置方式并不适合所有的开发和运维工程师关注，并且大多配置项可以固化下来，所以我们对配置进行了精简，并调整为简单的配置方式，这样可以更方便地在服务的源码项目的deploy目录下添加这部分配置，部署系统只需要负责将deploy中的配置生成为最终God可以读取的配置即可。</p>
<p><strong>（1）God的进程守护实现</strong></p>
<p>God的Worker线程通过两次fork的方式启动服务，将其放在后台，并获取服务的pid，后面对服务的控制都是通过该pid进行的。对于Resin、Nginx等Daemon服务，可以通过God原生支持的pid_file读取pid文件的方式获取，考虑到部分服务（如resin4.0以上版本）无法支持pid文件的情况，我们扩展了God，支持了pid_cmd配置，可以通过执行指定的命令来获取服务的pid。上述的pid_file和pid_cmd配置都是God在启动服务之后，异步执行来获取pid的。</p>
<p>获取到服务的pid之后，God周期性地探测服务是否存活，在发现服务进程不存在之后，会对服务进行重启。下面的配置描述的就是God对进程守护时各种状态的配置内容，flapping状态是God的一种内部状态，在God发现服务pid对应的进程不存在之后，标记为flapping状态，守护线程发现flapping状态的服务后，执行start操作重新启动服务。</p>
<p>同时，God通过c.times、c.within、c.retry_in、c.retry_times、c.retry_within五个配置来限制重启的次数，如下面的配置描述的就是在10分钟（c.within）之内，发现服务挂掉之后，最多重启6次（c.times），6次均重启失败后，等待10分钟（c.retry_in），在此期间，服务都处于异常状态，我们的监控系统会报警，同时God也会根据c.notify的配置发送邮件报警。如果等待10分钟（c.retry_in）之后服务还是处于异常状态，会再次尝试重启，并遵循10分钟内最多重启6次的原则。最后通过c.retry_times和c.retry_within来限制服务在1个小时之内最多只能重启200次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">  w.lifecycle do |on|</div><div class="line">    on.condition(:flapping) do |c|</div><div class="line">      c.to_state = [:start, :restart]</div><div class="line">      c.times = 6</div><div class="line">      c.within = 10.minute</div><div class="line">      c.transition = :unmonitored</div><div class="line">      c.retry_in = 10.minutes</div><div class="line">      c.retry_times = 200</div><div class="line">      c.retry_within = 1.hours</div><div class="line">      c.notify = &apos;proc_down&apos;</div><div class="line">    end</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>通过上面配置的一系列策略，可以确保服务在宕掉之后，会在第一时间被重启修复，重启几次失败后，通知人工介入修复。</p>
<p><strong>（2）借助God实现统一的服务启停和查看方式</strong><br>引入进程守护工具God之后，不管是人工操作还是部署系统，对服务的启停等操作就统一了。即god start $jobname为启动服务（$jobname代表服务名称，下同），god stop $jobname为停止服务，god status $jobname来查看服务运行状态，god log $jobname来查看服务日志。</p>
<p>在God原生的基础上增加了日志查看功能，即god log $jobname可以罗列出所有配置的日志文件，并通过指定序号来查看日志的滚动（例如：god log $jobname 2）。在上面的God配置中，我们配置了服务的stdout/stderr日志、程序日志的位置，这样就可以通过God来查看这些日志了。</p>
<p>配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[ ~]# god status</div><div class="line">nginx_nginx_production-lg[21962 root]: running (2015-03-25 13:04:53)</div><div class="line">nginx_scribe_production-lg[24829 work]: running (2014-11-17 11:59:06)</div><div class="line"> </div><div class="line">[ ~]# god log nginx_nginx_production-lg</div><div class="line">Usage: god log job.nginx_service.nginx_cluster.production-lg_pdl.account_owt.miliao_cop.xiaomi [0/1/2..]</div><div class="line">-----------------Log List ------------------</div><div class="line">1. God log</div><div class="line">2. Process log for /home/work/nginx/logs/https_account.xiaomi.com.log</div><div class="line">3. Process log for /home/work/nginx/logs/http_api.account.xiaomi.com.log</div><div class="line">4. Stdout log for /home/work/nginx/logs/nginx.run.log</div><div class="line"></div><div class="line">## 通过指定的序号查看日志的滚动</div><div class="line">[ ~]# god log nginx_nginx_production-lg 2</div></pre></td></tr></table></figure>
<p><strong>（3）借助God实现定时任务的部署</strong><br>在传统方式下，服务部署和服务相关的定时任务的发布是分离的，服务部署使用部署系统，定时任务通过人为方式管理或者通过另外一套独立的任务管理系统。</p>
<p>在我们设计部署发布规范时，要求定时任务跟随服务部署一起管理，其实现方式是在源码库中维护定时任务配置，在编译和发布包分发环节被带到具体的服务器上，在执行部署时生成最终的定时任务配置文件放置在/etc/god_cron.d/$jobname.cron中，此时定时任务还未生效，在执行god load $jobname后，God开始接管服务，同时将定时任务配置文件拷贝到/etc/cron.d/目录下，即在God开始管理服务的同时会生效定时任务；在执行god nuke $jobname后，会移除/etc/cron.d/$jobname.cron文件，即God移除接管的服务后清理相应的定时任务，从而支持在服务部署的同时管理相应的定时任务。实现定时任务部署的配置如下所示。</p>
<p>在源码的templates目下，需要放置cron对应的模板文件cron.erb：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">### 每小时清理一次日志</div><div class="line">01 * * * * &lt;%= scope[＂config::user＂] %&gt; /usr/sbin/tmpwatch --nodirs -m 72 /home/work/log/&lt;%= scope[＂config::jobname＂] %&gt;/</div><div class="line">在源码的Manifests的init.pp中，配置按模板生成对应的cron文件放到/etc/god_cron.d/目录下：</div><div class="line"> file &#123; ＂/etc/god_cron.d/&lt;%= scope[＂config::jobname＂] %&gt;.cron＂:</div><div class="line">    content =&gt; template(＂cron.erb＂),</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>5．Agent稳定性</strong></p>
<p>虽然引入了God进程守护工具，确保了其所管理的服务进程能够被正确守护，但是God自身的存活该如何保障呢？</p>
<p>在我们的部署系统中，我们通过Frigga和God之间的配合来完成：Frigga自身是通过God进行守护的（这一步是在Frigga初始安装的时候完成的），同时Frigga中有一段逻辑，周期性地判断God的存活情况，一旦发现God挂掉，会立刻重启God，这样通过God和Frigga的互相守护来确保它们的稳定性和存活率。Frigga和God互相守护示意图如图17-7所示。</p>
<p><img src="/images/15061708062799.jpg" alt=""></p>
<p>图17-7  Frigga和God互相守护示意图</p>
<h3 id="部署Web"><a href="#部署Web" class="headerlink" title="部署Web"></a>部署Web</h3><p>部署Web端最核心的功能是：友好地帮助用户触发编译，管理和生成部署配置文件，调用Odin执行服务部署动作。部署Web端整体结构示意图如图17-8所示。</p>
<p><img src="/images/15061708260563.jpg" alt=""></p>
<p>图17-8  部署Web端整体结构示意图</p>
<p>在部署中，发起部署任务的服务我们称为job。每个job都有独立的部署配置，Web会记录每个job的部署配置，方便后续选择版本和服务器列表就可以简单、快速地发起部署。</p>
<p>用户指定Git地址的版本号及相应的编译参数，部署Web端首先通知编译模块进行编译。编译模块判断该job的指定版本是否已经编译过，如果已经编译过，则直接返回成功；否则执行编译动作。编译成功后，部署Web端会根据页面配置的参数及编译模块返回的包地址组成部署配置文件，通知Odin发起任务。</p>
<p>后续用户在Web上的操作（暂停、取消部署等）会及时通知Odin，同时Odin的任务信息变化也会通知Web。这就是用户发起任务后，Web与周边交互的过程。</p>
<p>Web与周边交互的模块比较多，任务状态较为复杂，如图17-9所示为部署Web端任务时序图。</p>
<p><img src="/images/15061708428191.jpg" alt=""></p>
<p>图17-9  部署Web端任务时序图</p>
<p>图中黑色箭头为部署系统的控制流程，灰色箭头为用户的人工控制行为，粗体黑色箭头为一次常规的部署任务过程。</p>
<p>部署Web端的扩展功能包括管理版本、记录历史部署任务和便捷的回滚方案。另外还增加了一些其他的便捷性功能，比如服务器扩容时的整机job clone，能够在一台新的服务器上快速clone一个相同的服务环境。为了解决“job回滚版本”本身的复杂逻辑，我们重新定义了回滚的含义：一次回滚就是一次正常的部署任务，回滚时Web端自动填充默认配置数据。</p>
<h3 id="Build-Server设计"><a href="#Build-Server设计" class="headerlink" title="Build Server设计"></a>Build Server设计</h3><p>使用编译工具的目的是为了提供简单一致的打包方式，提供简单的编译方式，并确保输出的包满足规范，可以供部署系统直接使用。编译工具按照如下规则执行编译动作。</p>
<p>◎ 如果源码中存在build脚本，则执行build脚本。<br>◎ 如果未发现build脚本，则扫描目录下是否存在pom.xml，如果存在，则按照公司默认的Maven项目编译。<br>◎ 如果未发现pom.xml，则扫描是否存在Makefile；如果存在，则按照公司默认的C类语言编译。<br>◎ 依此类推，如果发现其他默认支持的配置，则按对应方式编译；如果扫描失败，则返回编译失败。</p>
<p>编译工具支持按分支、版本及tag方式获取源码，确保其能够支持多种类型的研发版本管理方式，以及开发、测试和hotfix环境下的分支部署。编译工具的上、下游关系示意图如图17-10所示。</p>
<p><img src="/images/15061708695188.jpg" alt=""></p>
<p>图17-10  编译工具的上、下游关系示意图</p>
<p>Web触发编译任务时，传入jobname、Git地址、Git分支及版本或tag，编译工具执行编译任务，并将发布包上传到产品库中。产品库使用分布式存储系统GlusterFS提供存储，通过HTTP方式提供上传和下载。</p>
<h3 id="部署系统小结"><a href="#部署系统小结" class="headerlink" title="部署系统小结"></a>部署系统小结</h3><p>在部署系统设计开发阶段，核心的工作是在前置规范的基础上，提供一整套的系统组件，包括部署控制中心Odin、服务器上的Agent（Frigga、Thor、God），以及提升使用便捷性的部署Web端。用户可以借助这套部署系统做到编码完成之后，一键将服务部署到开发、测试或线上环境中。</p>
<hr>
<h2 id="部署系统扩展"><a href="#部署系统扩展" class="headerlink" title="部署系统扩展"></a>部署系统扩展</h2><p>支持常规的服务部署之后，运维和开发工程师可以很方便地管理部署的任务，但是对于运维工程师来说，仅仅将服务部署到线上服务器还是远远不够的，接下来还需要去维护状态信息：需要更新前面章节中提到的服务树服务器列表信息，需要更新上、下游服务关联信息，如果部署的服务是LVS后端的Real Server还需要更新LVS配置，另外还需要更新监控配置。</p>
<p>如果上述这些操作都是手动进行的话，服务部署还不是真正意义的自动化，而且如何确保这些信息的准确性和有效性也是个问题。</p>
<p>完整的运维体系不仅包括服务器管理系统、监控系统、部署系统、关联管理系统、域名管理系统，还包括LVS管理系统（管理LVS的VIP及对应的后端Real Server列表）等。在涉及服务维护相关的各个运维系统中，部署系统是多个系统的触发点，因为只有部署系统会第一时间感知线上服务部署变动的情况。</p>
<p>因此，我们必须确保部署系统真正承担起触发的功能。为此，我们扩展了部署系统，使其能够更好地将部署情况第一时间通知到关联的系统。这些扩展功能包括：管理服务树配置、管理服务监控配置、部署对接测试、管理LVS配置、管理服务发现配置。下面先分析多系统联动的基础要素jobname，然后分析各个联动方案的细节。</p>
<h3 id="jobname"><a href="#jobname" class="headerlink" title="jobname"></a>jobname</h3><p>为了能够实现部署系统与其他运维系统的对接，首先我们需要确定一个在各个系统中都能够被识别并且唯一定位的服务名称，在本书中这个服务名称均称为jobname。有了这个全局唯一的jobname之后，我们就可以在其上关联相应的配置，比如服务对应的监控配置、对应的测试配置等。</p>
<p><strong>jobname在设计的时候必须考虑到满足如下需求。</strong><br>（1）能够唯一地表达jobname对应的服务，既具有可读性，也要便于系统的处理。<br>（2）能够兼容服务树的特性，如果jobname与服务树管理机器列表方式存在差异，必然导致中间交互环节需要进行转化操作，既不利于降低系统复杂度，也不利于人的理解。<br>（3）能够汇聚多维度信息（这一点也与服务树的特性一致），jobname中既要包括团队归属信息，也要标识服务自身信息（如业务名称、归属分组、归属集群等信息）。具备汇聚功能后，就可以抽象到一起进行管理，例如权限的配置可以在汇聚后授予、共性的监控可以汇聚后统一配置等。</p>
<p><strong>综合考虑上述需求后，我们确定了下面的jobname规范，并将其作为服务树和部署系统的管理基础，做到各个运维系统管理的一致性。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cop.xiaomi_owt.cloud_pdl.search_servicegroup.A_service.a_jobgroup.B_job.b_cluster.c1</div></pre></td></tr></table></figure>
<p>核心思想：jobname中应包含标识其属性的多个字段，每个字段为一个tag，每个tag包含一个key和一个value，将所有的tag串接起来组成最终的jobname。</p>
<p>tag包含服务的归属信息和服务自身的属性，表17-1中罗列了在部署系统中使用的各个tag的含义。</p>
<p><img src="/images/15061709630799.jpg" alt=""></p>
<p>表17-1  在部署系统中使用的tag的含义</p>
<p>通过cluster这个tag可以确定服务归属于哪个集群，通过cop、owt、pdl三个tag可以定位到服务的归属，通过两个必选的tag（service、job）和两个可选的tag（servicegroup、jobgroup一般用于分层分列较为复杂的服务）来描述服务自身的属性。通过上述tag可以全方位地描述一个服务。</p>
<p>有了jobname之后，各个运维系统就可以借助它关联到一起了。接下来分析部署系统是如何与其他几个运维系统进行联动的。</p>
<h3 id="对接服务树系统"><a href="#对接服务树系统" class="headerlink" title="对接服务树系统"></a>对接服务树系统</h3><p>服务树是运维各个系统中涉及服务器的一个基础平台，包括服务器登录权限、监控的报警策略等都需要借助服务树进行管理。在传统的管理方式下，服务树中的节点和服务器列表需要人工进行维护，这种方式极易出现配置信息更新不及时导致失效的情况。</p>
<p>因此，我们对这种方式进行了彻底变革，通过jobname进行关联，每次服务在服务器上部署后，都会将服务的jobname和服务器名称上报到服务树系统，服务树系统将服务jobname和服务器名称的关联关系记录下来。服务树汇总各个服务上报的信息后，就可以根据tag信息绘制出来一棵完整的服务树，示意图如图17-11所示。</p>
<p><img src="/images/15061710063867.jpg" alt=""></p>
<p>图17-11  服务树的合成示意图</p>
<p>每个服务在部署时，都会自动注册到服务树中，这样树的形成就由传统的手工维护方式转为自动生成，并且在服务部署、调整或者下线后，服务器列表能够在树中自动更新，解决了原来手动维护服务树混乱、遗漏和低效的问题。</p>
<p>前面已经讲到，服务部署到线上服务器后，进程守护工具God会开始接管服务。在这里我们充分利用了God的特性，定制了God在加载服务（load事件）配置时的动作，增加了注册服务树的环节，并定制了服务下线（nuke事件）时的动作，增加了从服务树摘除的环节。</p>
<p>注册的动作为调用服务树接口（HTTP接口），将服务器名称（hostname）和服务信息（jobname）上传到服务树系统，实现服务树的挂载动作；在执行god nuke $jobname之后，God会执行清理动作，调用服务树接口，将服务器从服务树对应节点下清除。God注册服务到服务树系统示意图如图17-12所示。God从服务树系统注销服务示意图如图17-13所示。</p>
<p><img src="/images/15061710457410.jpg" alt=""></p>
<p>图17-12  God注册服务到服务树系统示意图</p>
<p><img src="/images/15061710482935.jpg" alt=""></p>
<p>图17-13  God从服务树系统注销服务示意图</p>
<h3 id="对接监控系统"><a href="#对接监控系统" class="headerlink" title="对接监控系统"></a>对接监控系统</h3><p>公司自研的监控系统，在满足功能需求的同时，还给部署系统提供了丰富的API，确保部署系统在服务部署之后能够及时地更新服务监控。在监控系统中实现服务监控，有两块配置需要完成：数据采集项的上报配置和报警策略的配置。</p>
<p><strong>数据采集项的上报配置包括如下三类。</strong></p>
<p>◎ 服务器基础监控项：服务器负载及运行状态相关的采集项。这部分在所有的机器上都是一致的，由监控的Agent自动完成采集。<br>◎ 被动采集方式的服务监控项：在服务之外采集监控数据并上报，通常由服务管理的定时任务进行采集。<br>◎ 主动采集方式的服务监控项：服务自身进行监控数据的采集并上报。</p>
<p>在这三类数据采集项的上报配置中，只有被动方式的采集需要额外借助部署系统进行管理，支持的方式为在部署系统部署服务的同时部署监控数据采集的定时任务，即监控采集的任务被封装到脚本中，并配置定时任务周期性采集上报，定时任务及脚本随着服务进行部署。</p>
<p><strong>报警策略的配置包括如下两类。</strong></p>
<p>◎ 对于已经绑定到tag串的报警策略，部署系统在服务部署之后会自动更新tag串对应的服务器列表（即更新服务树的动作），之后报警策略在新服务器上会自动生效。</p>
<p>◎ 部分服务需要在部署时配置服务对应的报警策略，即在监控系统中增加报警策略，并增加服务对应的tag串与报警策略的对应关系。部署系统支持将报警策略定义为配置文件，并在部署服务的同时调用监控系统的API添加报警策略。<br>监控系统注册监控项和报警策略的动作均在God的load环节进行，具体示意图如图17-14所示。</p>
<p><img src="/images/15061711064141.jpg" alt=""></p>
<p>图17-14  God配置服务监控示意图</p>
<p>God从监控系统注销监控示意图如图17-15所示。</p>
<p><img src="/images/15061711143907.jpg" alt=""></p>
<p>图17-15  God从监控系统注销监控示意图</p>
<p>具体的监控系统API，可以参考“监控系统”部分中的描述。</p>
<h3 id="对接测试"><a href="#对接测试" class="headerlink" title="对接测试"></a>对接测试</h3><p>将服务部署到服务器上之后，还有一个重要的环节是确认服务是否正常运行。在传统的服务部署时，需要在部署后去人工观察服务的运行情况，包括进程是否正常、启动的日志是否正常，观察无异常后，再尝试引入小量的请求来观察服务的状态和日志，以此来判断服务运行是否符合预期。</p>
<p>这种人工检查的方式耗时比较长，而且可能会出现无法及时发现服务运行不正常的情况。在服务变更引发故障的案例中，有一部分就是由于部署后的服务运行不符合预期但是没有及时发现所导致的。因此我们在设计部署系统时，专门考虑了服务检查的需求，解决方法是部署系统对接测试。</p>
<p>实际上，在服务研发完成后，研发人员会利用一些测试用例来验证功能是否满足需求，而后提交给测试人员，测试人员会维护服务对应的一套完整的功能和回归测试case。如果这些测试用例能够在线上服务器上再执行一遍，就可以及时发现部署后的服务是否正常运行，唯一的区别是这个环节需要注意去除那些对线上数据有破坏的测试用例。</p>
<p>在部署的配置中，我们增加了测试用例的配置，并扩展了部署系统，支持在部署完成后执行测试动作。</p>
<p><strong>这部分配置包括两类：每个实例运行的测试用例和全局运行的测试用例。</strong><br>◎ 实例测试用例在部署完每个服务实例之后被触发执行。这类测试用例在单机上执行，可以调用服务在本机提供的接口，以测试服务实例自身的运行状况。</p>
<p>◎ 全局测试用例在部署任务整体执行完成后被触发执行。这类测试用例不在服务实例所在的机器上执行，而是在专门的机器上执行，可以请求整体服务，或者模拟客户端进行调用，甚至可能直接请求服务对外的公网接口，来测试服务整体的运行状态。部署系统对接测试示意图如图17-16所示。</p>
<p><img src="/images/15061711435870.jpg" alt=""></p>
<p>图17-16  部署系统对接测试示意图</p>
<p>通过引入部署系统对接测试之后，能够确保每个服务实例在部署之后的行为符合预期，也能够确保产品整体提供的服务是正常的，这样就极大地减少了服务部署后遗留的潜在问题影响到服务可用的情况。</p>
<h3 id="对接LVS管理系统和服务发现系统"><a href="#对接LVS管理系统和服务发现系统" class="headerlink" title="对接LVS管理系统和服务发现系统"></a>对接LVS管理系统和服务发现系统</h3><p>在传统方式下，如果服务需要挂载在LVS后面，那么部署完服务后，还需要去LVS管理系统中手动更新LVS配置。另外，服务的上、下游关联关系，也需要手工进行维护。这两件事情也是运维工程师的痛点。在设计部署系统时，我们也想办法解决了部署系统与LVS管理系统联动、与服务发现系统联动的问题。</p>
<p>LVS和服务发现的注册需要在部署配置中增加相应的描述，其中LVS管理系统需要配置注册的VIP:PORT和本地监听的IP:PORT，服务发现系统注册需要配置本地监听的IP:PORT，其目的挂载点即服务jobname对应于服务发现系统中的节点。考虑到LVS管理系统和服务发现系统注册的时候，应该确保服务是存活的，因此注册的动作被设计为God成功启动服务之后进行。相应地，注销的动作在God发现服务宕掉后或者被主动停止前进行。</p>
<p>在部署系统中注册和摘除LVS配置、服务发现配置的示意图分别如图17-17和图17-18所示。</p>
<p><img src="/images/15061711659420.jpg" alt=""></p>
<p>图17-17  God配置服务发现系统和LVS管理系统示意图</p>
<p><img src="/images/15061711725908.jpg" alt=""></p>
<p>图17-18  God从服务发现系统和LVS管理系统中摘除服务示意图</p>
<h3 id="部署系统扩展小结"><a href="#部署系统扩展小结" class="headerlink" title="部署系统扩展小结"></a>部署系统扩展小结</h3><p>在部署系统扩展方面，主要解决的是部署系统如何与其他关联运维系统对接，包括服务树、监控、测试、LVS、服务发现等系统，增加部署系统与各个系统的联动，保证在服务部署后，相关系统的配置能够及时得到更新，增强各个系统配置的准确性，减轻运维工程师的工作复杂程度。在这个阶段中，一个通行的设计是在服务的项目源码中增加需求所对应的配置，并借助部署动作生成God的配置，最终由God来完成相应的联动需求。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章主要分析了部署系统从零开始到满足基本的服务部署需求的整个历程。前期，部署系统关注的是如何将服务稳定、高效地部署到线上；后期，部署系统会侧重解决与其他系统的联动，确保在感知服务部署状况发生变化后，能够自动更新到关联的运维系统中。</p>
<p>完成上述功能之后，部署系统只是解决了一部分运维自动化的需求，还有一些更智能化的运维需求需要部署系统去继续支持。这些智能化的需求包括：故障实例的自动迁移、自动扩容/缩容、复杂的服务混合部署、彻底的资源隔离，以及全动态的部署调度等。</p>
<p>部署系统为了支持这些需求，引入了Docker进行资源隔离，引入了Mesos进行资源调度，同时与服务发现系统和监控系统进行了更多的交互。由于这一部分涉及的内容较多，因此单独安排了下一章“动态调度”来详细分析。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ღ ღ ღ 如果觉得文章对您有用，不妨打赏一下ღ ღ ღ</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="于龙君 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="于龙君 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      于龙君
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.yulongjun.com/under-the-ops/20170923-17-deploy-system/" title="第十七章：部署系统">http://www.yulongjun.com/under-the-ops/20170923-17-deploy-system/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Deploy-System/" rel="tag"># Deploy System</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/under-the-ops/20170923-16-service-discovery/" rel="next" title="第十六章：服务发现">
                <i class="fa fa-chevron-left"></i> 第十六章：服务发现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/under-the-ops/20170923-18-dynamic-scheduling/" rel="prev" title="第十八章：动态调度">
                第十八章：动态调度 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODAzMy80NjA3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="于龙君" />
          <p class="site-author-name" itemprop="name">于龙君</p>
           
              <p class="site-description motion-element" itemprop="description">Linux, Python, macOS</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">224</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">281</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/yu-long-jun" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-quora"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1302333987" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/yulongjun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/__YuLongjun__" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.178linux.com/" title="Linux运维部落" target="_blank">Linux运维部落</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ttlsa.com/" title="运维生存时间" target="_blank">运维生存时间</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.sliverstack.com/" title="李恒的博客" target="_blank">李恒的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.qqlilin.com/" title="李林的博客" target="_blank">李林的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://vinnywang.com/" title="王楠的博客" target="_blank">王楠的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhaodaxin.com/" title="赵大鑫的博客" target="_blank">赵大鑫的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blog.whsir.com/" title="吴昊的博客" target="_blank">吴昊的博客</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署系统综述"><span class="nav-number">1.</span> <span class="nav-text">部署系统综述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署系统的前置规范"><span class="nav-number">2.</span> <span class="nav-text">部署系统的前置规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#软件依赖问题的解决"><span class="nav-number">2.1.</span> <span class="nav-text">软件依赖问题的解决</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译规范及编译部署的联动"><span class="nav-number">2.2.</span> <span class="nav-text">编译规范及编译部署的联动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线上目录的规范"><span class="nav-number">2.3.</span> <span class="nav-text">线上目录的规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署系统设计"><span class="nav-number">3.</span> <span class="nav-text">部署系统设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署系统结构"><span class="nav-number">3.1.</span> <span class="nav-text">部署系统结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署系统组件"><span class="nav-number">3.2.</span> <span class="nav-text">部署系统组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署Web"><span class="nav-number">3.3.</span> <span class="nav-text">部署Web</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Build-Server设计"><span class="nav-number">3.4.</span> <span class="nav-text">Build Server设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署系统小结"><span class="nav-number">3.5.</span> <span class="nav-text">部署系统小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署系统扩展"><span class="nav-number">4.</span> <span class="nav-text">部署系统扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jobname"><span class="nav-number">4.1.</span> <span class="nav-text">jobname</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对接服务树系统"><span class="nav-number">4.2.</span> <span class="nav-text">对接服务树系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对接监控系统"><span class="nav-number">4.3.</span> <span class="nav-text">对接监控系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对接测试"><span class="nav-number">4.4.</span> <span class="nav-text">对接测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对接LVS管理系统和服务发现系统"><span class="nav-number">4.5.</span> <span class="nav-text">对接LVS管理系统和服务发现系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署系统扩展小结"><span class="nav-number">4.6.</span> <span class="nav-text">部署系统扩展小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">于龙君</span>
</div>
<div>
  <a href="http://www.miitbeian.gov.cn/">京ICP备17049401号</a>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("xL6oGKp3T8SyrCjhb93y6RVx-gzGzoHsz", "HGXc2Np0bSets9V1GCOYz0f4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

</body>
</html>
