<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="uA6X_uCQhJlvOqusYftnLIrCAgA25_lWAqRT5YZrnwU" />













  
  
    
  
  <link href="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Service Discovery," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="article">
<meta property="og:title" content="第十六章：服务发现">
<meta property="og:url" content="http://www.yulongjun.com/under-the-ops/20170923-16-service-discovery/index.html">
<meta property="og:site_name" content="于龙君的博客">
<meta property="og:image" content="http://www.yulongjun.com/images/devops.png">
<meta property="og:image" content="http://www.yulongjun.com/images/15061696114772.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061696204598.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061697069039.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061697259686.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061697701298.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061697819747.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061697995900.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061698425115.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061698891530.jpg">
<meta property="og:image" content="http://www.yulongjun.com/images/15061699771658.jpg">
<meta property="og:updated_time" content="2017-09-23T15:24:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第十六章：服务发现">
<meta name="twitter:image" content="http://www.yulongjun.com/images/devops.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yulongjun.com/under-the-ops/20170923-16-service-discovery/"/>





  <title> 第十六章：服务发现 | 于龙君的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-107783004-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e7d6cfa254b42afe3c433690cfa6b887";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">于龙君的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay foolish, stay hungry, and don't be evil.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux">
          <a href="/categories/linux" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            Linux
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/python" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-file-code-o"></i> <br />
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-macos">
          <a href="/categories/macos" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-apple"></i> <br />
            
            macOS
          </a>
        </li>
      
        
        <li class="menu-item menu-item-server">
          <a href="/categories/server" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-server"></i> <br />
            
            服务器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-database">
          <a href="/categories/database" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-database"></i> <br />
            
            数据库
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/categories/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud"></i> <br />
            
            Cloud
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essay">
          <a href="/categories/essay" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-pencil-square"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-under-the-ops">
          <a href="/categories/under-the-ops" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gears"></i> <br />
            
            《运维之下》转载
          </a>
        </li>
      
        
        <li class="menu-item menu-item-donate">
          <a href="/donate" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-credit-card"></i> <br />
            
            赞助
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user-secret"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.yulongjun.com/under-the-ops/20170923-16-service-discovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="于龙君">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="于龙君的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                第十六章：服务发现
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-23T17:19:37+08:00">
                2017-09-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/under-the-ops/" itemprop="url" rel="index">
                    <span itemprop="name">under-the-ops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/under-the-ops/20170923-16-service-discovery/" class="leancloud_visitors" data-flag-title="第十六章：服务发现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/devops.png" alt="devops"><br><a id="more"></a></p>
<p>在一个分布式系统中，两个服务需要进行RPC交互，主调方如何知道被调方的IP地址和端口呢？在被调方可能随时变更的情况下，这个问题会被进一步复杂化。</p>
<p>最简单的服务间关系如图16-1所示。<br>复杂的服务间关系是，一个主调方需要调用多个不同服务的接口，如图16-2所示。</p>
<p><img src="/images/15061696114772.jpg" alt=""></p>
<p>图16-1  最简单的服务间关系 </p>
<p><img src="/images/15061696204598.jpg" alt=""></p>
<p>图16-2  复杂的服务间关系</p>
<p>除了有一个主调方要请求多个被调方之外，每个被调方又可能有多个服务实例在运行，那么管理这些调用关系，并且让服务可靠地运行就是一件很复杂的事情了。</p>
<p><strong>实例一：</strong><br>某公共服务接口层下线几台服务器，当没有服务发现机制时，所有调用该接口服务的服务进程，均需要同步改变连接配置，并重启生效；否则就会出现请求失败，容错做得不好甚至会影响服务可用性。如果请求此接口的服务很多，甚至跨很多产品线，那么配置修改会是个很恐怖的沟通和实施过程，而且所有的配置修改均是人工变更，很容易因出错而造成故障。<br>扩容服务器情况也是类似的，扩容不会影响服务可用性，但可能因为调用方没有同步修改连接配置，而导致被调方流量不均衡。</p>
<p><strong>实例二：</strong><br>中间层服务要PaaS化，如果没有服务发现机制，就是个不可能实现的目标。因为PaaS化的一个重要特性就是，在部署、迁移、扩容时，服务实例的位置（IP地址和端口）会动态变化，随机分配；而且任何故障都可能触发实例迁移，IP地址和端口也随之变化，如果客户端不能同步地自动变更连接，就会一点点丢失服务端实例，无法实现真正意义的PaaS化。</p>
<p>服务发现在众多运维基础设施中是个比较特殊的存在。其他基础设施故障，顶多损失一些功能，如不能发布程序，不能登录服务器，或者监控故障导致工程师不知道线上服务状况等。但如果服务发现系统出了问题，又没有相应的技术来容灾，线上所有主调服务都将变成瞎子，找不到被调服务，从而使所有线上业务同时出现故障。</p>
<p>所以服务发现的业务需求，会对容错、容灾及可用性设计有严格的要求，同时还要考虑如何降低老业务程序接入的成本，即考虑负载均衡和集成方式。我们需要考虑以下问题。<br>容错——如果服务注册失败会发生什么？如果注册超时，或者其他进程突然处于离线状态，又会发生什么？这要求服务发现系统提供心跳机制，以便确定服务的存活性，并且需要有能力可靠地处理失效的服务。</p>
<p><strong>容灾</strong>——如果服务发现系统及其所在网络区域发生网络分区，服务发现功能是否能得到预期的结果，而不是完全不确定性地崩溃？<br><strong>可用性</strong>——所有应用程序集成服务发现后，是否完全依赖注册中心的可用性？注册中心升级时会中断服务吗？<br><strong>负载均衡</strong>——如果多个被调方服务实例被注册到一个服务名字上，怎样让主调方流量均衡到每个被调方服务实例上？<br><strong>集成方式</strong>——注册中心如何提供API和SDK？是否需要支持多种开发语言？在集成时，是要将代码嵌入到应用程序中，还是可以选择一个代理进程？</p>
<p>带着以上这些问题，我们看看传统模式和开源项目是怎样解决的。<br>注：网络分区是指因为某种网络故障，造成原本处于一个局域网的服务器或设备出现无法互访的现象，好像被分割成了两个或多个区域。</p>
<h3 id="传统模式"><a href="#传统模式" class="headerlink" title="传统模式"></a>传统模式</h3><p>在经典的服务发现解决方案出现之前，服务发现主要有如下三种模式。<br>◎ 硬配置——主调方硬配置被调方的IP地址:端口列表，自行对被调方进行负载均衡和健康检查、容错。在这种模式下，主、被调方的关联与配置强耦合，被调方发生自动的或人为的规模增减或者位置迁移（IP地址或端口变更），都要修改主调方的配置并重启服务生效。随着系统规模的不断扩大，这个问题也被进一步放大，情况变得难以控制。</p>
<p>◎ 流量代理——LVS、HAProxy、业务总线等均属于这种模式。从主、被调方解耦来看，这种模式解决了问题，每个被调方服务暴露一个IP地址:端口给主调方，主调方不用关心它下面实际对应哪些IP地址:端口列表，甚至不用关心负载均衡问题。看起来很好，但它也有比较大的问题。</p>
<p><strong>首先</strong>，配置仍是静态的，需要人工维护，被调方配置集中由LVS、业务总线管理，配置出错可能大面积影响服务，若是配置分散的HAProxy，运维管理成本又太大</p>
<p><strong>其次</strong>，新增的流量代理组件，它本身将会成为单点和压力瓶颈，即便可以用OSPF或Gossip等协议让LVS组件集群化，达到多机同时服务，但因流量均要经过此组件，它的可靠性会直接影响依赖它的所有服务，耦合也还是太重，风险过大</p>
<p><strong>最后</strong>，无论是LVS的四层转发，还是业务总线的七层转发，都无法避免庞大的内网流量经过流量代理组件带来的负载，业务总线模式在这个问题上更加突出，会在流量代理组件上浪费大量的服务器和内网带宽。</p>
<p>◎ DNS——用域名来隐藏并解耦多个被调方IP地址。这种模式局限很多，比如还是要主调方维护端口配置，当被调方端口不同时难以处理。而且DNS协议的轮询不能实现完全的负载均衡，会造成被调方负载不均衡。</p>
<p>可见，以上几种模式都不够完善，不适合作为服务发现的通用解决方案。</p>
<h2 id="开源实现"><a href="#开源实现" class="headerlink" title="开源实现"></a>开源实现</h2><p>服务发现作为分布式系统大规模复杂架构和动态调度部署的重要组件，开源有很多种实现，不同开源软件实现的思路也有很大不同。</p>
<p>从底层实现角度看，主要分为两类。<br>一类是采用异步的Gossip协议，用Agent聚簇（去中心化）的方式完成服务实例注册和查询功能。这类基本只有Serf一个经典实现，为了注册服务，Serf Agent会将自己连接进一个已存在的聚簇中，Agent可以通过自定义标签附带主机角色、环境、IP地址、端口等元数据。一旦某个Agent连接到聚簇，聚簇的其他成员就可以看到这个主机和它的元数据。Serf用弱一致性换取良好的容错能力和可用性，是一个不错的开源服务发现，适合规模较小的场景。</p>
<p>另一类是使用中心化的一致性存储，作为服务注册、变更、查询的载体，业内99.9%的服务发现系统都属于此类。其中比较经典的一致性存储有ZooKeeper、Etcd、Consul、Eureka。</p>
<p>下面分别介绍各个开源服务发现系统的设计细节。</p>
<p><strong>1．ZooKeeper</strong></p>
<p>◎ 老牌一致性存储，采用较复杂的Fast Paxos算法保证一致性，API最丰富完善，但对用户而言也较为复杂。<br>◎ 共有三种角色：Leader、Follower和Observer。前两者参与选举，个数之和应为奇数，数量越多读性能越好，但同时写性能越差（每次写请求都要经过选举）；Observer不参与选举，仅同步数据和接受客户端连接，用于不降低写性能地扩展读性能。<br>◎ 在注册EPHEMERAL类型节点时，客户端与服务端采用长连接保持此节点，当连接断开后此节点自动消失，同时提供Watch功能，当节点发生更新时向客户端触发事件。这两个特性很重要，它们共同提供了早期服务发现系统的基础模型。<br>◎ 支持分布式锁，由于ZooKeeper的设计中有保证时序性，因此可保证先抢到锁的才能持有锁。</p>
<p><strong>2．Etcd</strong></p>
<p>◎ 一致性存储新贵，采用更轻量的Raft算法实现选举一致，因此写性能比ZooKeeper高出不少，单实例可以达到1000 Write QPS。<br>◎ 提供HTTP+JSON的RESTful API，更加易用和方便集成。<br>◎ 通过TTL对已注册的客户端进行健康检查，相比ZooKeeper而言更能容忍网络抖动，TTL时长可根据用户网络情况定义合理值，以便在容忍网络抖动和服务敏感度之间进行折中。<br>◎ 同样提供数据改变监视、多值、目录监听和支持分布式锁等功能。<br>◎ 方便的原子操作——CAS（Compare-and-Swap）和CAD（Compare-and-Delete）</p>
<p><strong>3．Consul</strong></p>
<p>◎ 使用Raft算法来保证一致性，同Etcd。<br>◎ 支持多数据中心，内外网的服务采用不同的端口进行监听。多数据中心集群可以避免单数据中心的单点故障。<br>◎ 支持七层协议的健康检查，允许用户自定义检查协议和策略。<br>◎ 支持HTTP和DNS两种协议接口。<br>◎ 官方提供Web管理界面。<br>◎ Consul的客户端无状态，负责将HTTP和DNS接口请求转发给局域网内的服务端集群。<br>◎ Consul的服务端负责保存配置信息，通过Raft协议形成集群，在局域网内与本地客户端通信，在广域网内与其他数据中心通过Gossip协议聚簇并互相转发请求。每个数据中心的服务器数量推荐为 3或5台。<br>Consul架构示意图如图16-3所示。</p>
<p><img src="/images/15061697069039.jpg" alt=""></p>
<p>图16-3  Consul架构示意图</p>
<p><strong>4．Eureka</strong></p>
<p>◎ Netflix开源的服务发现系统，支持负载均衡和服务发现。</p>
<p>◎ 并非强一致性，而是最终一致性。各台Eureka服务器使用Gossip协议聚簇构成一个Cluster，彼此之间异步复制状态。</p>
<p>◎ 如果一台服务器出现问题，Eureka不需要任何类型的选举，客户端会自动切换并连接到一台新的Eureka服务器。当它恢复时，可以自动加入Eureka节点集群。按照设计，它可以在零停机的情况下处理更广泛的网络分区问题，在出现网络分区的情况下，Eureka可以继续接受新的注册并发布，同时可以确保新增服务仍然可以供分区同侧的任意客户端使用。</p>
<p>◎ Eureka有一个服务心跳的概念，可以阻止过期数据。如果一个被调方服务长时间没有发送心跳，那么Eureka将从服务注册中将其删除。但在出现网络分区、Eureka在短时间内丢失过多客户端时，它会停用这一机制，进入“自我保护模式”。网络恢复后，它又会自动退出该模式。这样，虽然它保留的数据中可能存在错误，但却不会丢失任何进入保护模式前的有效数据。</p>
<p>◎ Eureka在客户端会有缓存。即使所有的Eureka服务器不可用，服务注册信息也不会丢失。只有当所有的Eureka服务器都没响应的情况下才会用到缓存，因此缓存机制也是可靠的。</p>
<p>◎ Eureka就是为服务发现而构建的，它提供了一个完整的客户端库，该库提供了服务心跳、服务健康检查、自动发布、缓存刷新以及负载均衡和容错等功能。</p>
<p>◎ 管理简单，很容易添加和删除节点。官方提供了简洁的UI，能够展现所有的服务及其健康状况。</p>
<p>◎ Eureka还提供了RESTful API，使用户更易将其集成到其他可能的用途。<br>Eureka架构示意图如图16-4所示。</p>
<p><img src="/images/15061697259686.jpg" alt=""></p>
<p>图16-4  Eureka架构示意图</p>
<p>开源的实现方案，从应用接入角度看，主要分为三类。</p>
<p><strong>第一类是直接使用流量代理模式。</strong>这类的特点是，通过一致性存储自动发现注册和变更，并自动编排每个本地流量代理配置，来达到访问一个VIP自动负载均衡到其后配置的多个IP地址:端口的功能。这类的优点是集成简单，完全不需要侵入代码来支持服务发现，且开发者不需要考虑负载均衡问题；缺点是VIP不是一个容易被管理和记忆的媒介，且每个业务程序前多了一个流量代理组件，增加了性能损耗，同时也增加了因流量代理故障造成业务故障的可能性。这类的经典实现有SmartStack、Bamboo（Mesos）。</p>
<p><strong>第二类是使用中心化服务器来承载服务发现系统，提供RESTful API进行服务注册、变更、查询，也是通过增加本地客户端来提升可用性和API易用性的。</strong>这类的优点是方便服务端实现更多的复杂功能；缺点是需要侵入业务程序代码完成集成和负载均衡功能，集成难度较大。这类的经典实现很多，如Eureka、Consul、Confd、Discovery等。</p>
<p><strong>第三类也是以中心化服务器来承载服务发现系统，但以DNS协议为基础，通过DNS协议暴露服务注册、变更、查询等功能。</strong>这类的优点是方便服务端实现更多的复杂功能，同时通用的DNS协议集成方式比较简单（无论gethostbyname系统调用还是host命令），还可以通过权重方式获得伪负载均衡；缺点是客户端难以随时变更后端IP地址:端口，会造成实际负载不均衡，且主调方也无能力改变负载均衡策略。这类的经典实现有SkyDNS、Spotify，另外Consul也提供了DNS协议的组件及接口。</p>
<p>服务发现的开源实现很多，有一些已经相当成熟，因此在我们的工程实践中，也是基于开源项目进行二次开发，实现公司业务场景上的一些特定需求。</p>
<h2 id="第一版设计"><a href="#第一版设计" class="headerlink" title="第一版设计"></a>第一版设计</h2><p>我们很早就设计了第一版服务发现系统，这对前、中期的运维平台建设起到至关重要的作用。这一期选型使用了当时比较成熟的ZooKeeper承载服务发现系统。</p>
<p>我们将服务注册（长连接保持）、服务查询功能，通过统一的Java Thrift RPC框架，集成进客户端和服务端应用进程，并由RPC框架负责负载均衡。使用ZooKeeper的长连接和订阅通知机制，来获知被查询服务实例是否存活。</p>
<p>在可用性方面，ZooKeeper的设计目标符合CAP定理中的CP，即满足一致性和分区容忍性，但分区时的可用性无法保证。因此我们规划以逻辑IDC为单位，垂直拆分ZooKeeper集群，每个ZooKeeper集群服务于一个IDC环境，这样就减少了IDC间专线故障造成的分区可能性，变相提高了系统的可用性。</p>
<blockquote>
<p>注：CAP定理是指在设计分布式系统时，一致性（Consistent）、可用性（Availability）、分区容忍性（Partition Tolerance）三个属性不可能同时满足，该定理也叫作布鲁尔定理。CAP定理明确了分布式系统所能实现系统的局限性。<br>部署结构示意图类似于图16-5。</p>
</blockquote>
<p><img src="/images/15061697701298.jpg" alt=""></p>
<p>图16-5  部署结构示意图</p>
<p>但仅按IDC粒度垂直拆分ZooKeeper集群，仍无法对抗IDC内部的分区问题，也无法对抗ZooKeeper集群本身的故障问题，因此我们在统一的RPC框架中，提供了本地快照机制：保存最后一次成功请求的服务位置信息，当请求ZooKeeper失败时，使用本地快照，在一定心跳周期后，再尝试恢复ZooKeeper请求，这样也就可以部分容忍ZooKeeper集群的故障，发生故障时无法注册新的被调服务实例，但不影响服务的现有连接。</p>
<p>在正常情况下，客户端请求服务端，有变更则写入本地文件缓存中，如图16-6所示。<br>在异常情况下，客户端请求服务端失败，改请求本地文件缓存，直到重新感知服务端恢复，如图16-7所示。</p>
<p><img src="/images/15061697819747.jpg" alt=""></p>
<p>图16-6  客户端与服务器正常交互</p>
<p><img src="/images/15061697995900.jpg" alt=""></p>
<p>图16-7  客户端与服务器正常交互</p>
<p>以上可用性设计，在线上运转4年，有很高的可靠性，基本未出现过因ZooKeeper造成的线上大规模故障。</p>
<p>业务除了服务发现需求外，还有较小部分的附带信息需求，当时为简化设计，也允许这些信息存储在ZooKeeper里。如果想附带额外的信息，如版本号、协议、一致性哈希路由表等信息，RPC框架也提供API自定义数据结构附加在服务名字节点上，可供客户端获取和使用。</p>
<p>此方案简单有效，沿用至今，服务发现的关键需求都能够满足，线上服务覆盖率已高达90%。我们在初期就具备了服务发现能力，这对运维自动化的建设起到了非常大的推进作用。</p>
<h2 id="第二版设计"><a href="#第二版设计" class="headerlink" title="第二版设计"></a>第二版设计</h2><p>第一版基于ZooKeeper的服务发现系统，在很大程度上帮助工程师提高了对服务管理的掌控力。通过服务发现系统，工程师在服务器扩容、故障屏蔽方面获得了极大的便利，我们不用关心上、下游的服务具体的服务器调整，业务程序通过服务发现可以自动感知。但在第一版的服务发现系统中，也存在着如下一些缺点。</p>
<p>可用性风险——ZooKeeper设计的CP定位，决定了它无法保证分区时的可用性，靠拆分IDC部署和本地快照机制，虽然能变相提升可用性，但无法解决出现双主场景数据不一致的情况；采用ZooKeeper的长连接机制，当服务规模足够大时，网络的抖动可能会带来广播流量的风险。我们希望有更完善的可靠性保障，毕竟服务发现是个典型的AP系统，可靠性是第一要务。</p>
<p>第三方组件难以集成——由于之前仅提供代码嵌入的方式集成，对于Java、C等语言开发的业务App比较容易接入，但一些开源组件如MySQL、Nginx、Redis等，很难嵌入代码实现集成。这些服务在线上环境中使用很广泛，我们希望设计新的服务发现系统，可以更好地兼容应用服务和第三方服务。</p>
<p>注册安全问题——一个业务程序有可能通过一些代码Hack，非法注册为另一个业务程序的服务名字，这样就能够非法截获流量甚至数据。这是比较大的安全风险。</p>
<p>使用混乱——对于ZooKeeper的使用，限制不够严格：允许自定义一些树状结构，也允许在服务节点下自定义配置，还允许部分位置信息是人为静态配置的，因此运维成本很高，尤其是在服务机房间迁移时困难重重。我们希望通过设计规划它的使用方式，带来更多的运维便利性。</p>
<p>服务间关联信息缺失——在第一版的设计中，无法很好地记录谁访问谁这类信息。当一个公共服务公开接口，将服务名字注册到服务发现系统中时，它的维护者无法知晓其被哪些主调方请求。我们希望可以记录被调方的身份及IP地址等信息，供后续挖掘出完整的服务间关联关系。</p>
<p>控制服务间路由和降级开关——我们还希望通过服务发现机制，提供内部灵活调整服务间路由的能力，这项能力在服务机房间迁移时具有超凡的意义。试想：在服务机房间迁移时，我们总是用空间换时间（准备与当前数量相同的服务器集群，在另一个机房完全搭建好服务，切换流量），或者用时间换空间（另一个机房只有几台机器，迁移小部分服务，机器迁移，再迁移部分服务，在中间状态过程中，即使很好地利用了服务发现系统，也依然要频繁地修改配置）。我们可以模拟域名的CNAME，这样就具备了瞬间调整任一层服务路由的能力，同时也具备了提供降级开关的能力。</p>
<p>兼容区域化解析和跨区域访问——区域化解析是指当不指定区域时，默认解析本区域内的服务名字，这对去除配置差异化具有重要意义；跨区域访问是指可以自由解析其他区域的服务名字，这是为部分存在Master的服务架构进行的必要折中。</p>
<p>基于上述问题的考虑，我们重新梳理了服务发现系统的功能和目标，进行了第二版的设计。在第二版中，我们着重考虑服务可用性，提供更丰富的接入方式，解决安全隐患，同时兼顾实现各种高级功能。</p>
<h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p>在第二版设计中，我们增加了不少高级功能，如区域化解析、服务间路由切换、关联关系展示、安全注册等。所以在整体功能模块架构上有了较大变化，如图16-8所示。</p>
<p><img src="/images/15061698425115.jpg" alt=""></p>
<p>图16-8  整体功能模块架构示意图</p>
<p>业务流程为：提供两种接入方式，业务App集成SDK直接注册，或者由部署系统的守护组件God监听业务App并代理注册，注册行为都是先注册到本服务器的Eureka Client，再由Eureka Client注册到Eureka Server。Secure Server用来防御用户伪造注册，Dashboard接Eureka Client旁路数据用以绘图。</p>
<p>架构设计重点如下：<br><strong>（1）重客户端，轻SDK</strong><br>为了方便未来开源，把更多的逻辑封装进客户端；同时也降低了SDK的封装工作，尤其在多种开发语言并存的业务环境下，降低了集成成本。另外提供了程序和第三方工具（God，详见下一章介绍）两种集成方式。</p>
<p><strong>（2）Eureka Server通过Gossip协议实现集群化</strong><br>部署在多个IDC机房的Eureka Server，通过Gossip协议聚簇成Cluster后，可容忍网络分区，同时具备超高的可靠性，且可轻松进行水平扩展。</p>
<p><strong>（3）不为业务提供流量代理</strong><br>之前已经分析过流量代理模式的缺点，流量代理将会成为整个系统的负载瓶颈，即使将流量代理完全分散化，也会带来无谓的性能消耗和延迟，延迟又意味着业务程序的性能下降。因此，我们的业务SDK仅去发现服务位置，通过服务位置直连，降低性能消耗和延迟。</p>
<p><strong>（4）客户端旁路上报调用关系数据</strong><br>不额外增加注册中心服务端的负载，而是利用每个客户端的能力，将调用信息有针对性地上报到Dashboard，然后绘出服务关系图谱。上报及绘图带来的负载，均不会对服务发现系统产生影响。</p>
<p><strong>（5）防止假冒身份注册安全问题</strong><br>在Eureka Client和Eureka Server间，增加第三方Secure Server来防范假冒身份，保护请求和数据安全。</p>
<h3 id="注册中心选型"><a href="#注册中心选型" class="headerlink" title="注册中心选型"></a>注册中心选型</h3><p>对于注册中心的选型，我们放弃了使用类Paxos算法确保存储一致性的ZooKeeper/Etcd/Consul等；而把眼光放在了自行对接形成聚簇，并异步复制状态的Eureka/Serf，最终选定了Eureka。主要考虑如下：</p>
<p>在ZooKeeper中，网络分区中的客户端节点无法到达ZooKeeper的最小法定节点时（如5个节点的集群最小法定节点为3），就会与ZooKeeper失去联系，从而也就无法使用其服务发现机制了。因此，在用于服务发现时，ZooKeeper无法很好地处理网络分区问题。</p>
<p>对于服务发现来说，发现的位置信息中可能包含错误要好于没有信息。虽然我们可以像Pinterest和Airbnb等公司那样，通过客户端缓存和其他技术弥补这种缺陷，但这并不能从根本上解决问题。如果所有节点完全不可用，或者集群分区和客户端都恰好连接到了不属于这个分区但仍然健康的节点，那么客户端状态仍将丢失。</p>
<p>更重要的是，上述做法的本质是试图用缓存提高一致性系统的可用性，即在一个CP系统之上构建AP系统，这是与CAP定理相背离的。而服务发现系统从设计之初就应该针对可用性而设计。</p>
<p>同样的，Etcd和Consul无论如何也仍然是CP系统，用以构建AP系统有些牵强。但若对可用性要求降低一些，Consul其实可以算是个不错的选择，其多机房多实例用Gossip聚簇的设计已经可以满足大多数苛刻的架构要求。</p>
<p>而Eureka的弱一致性设计，让它可以在网络分区时，不会出现整个集群故障，同时Eureka客户端可以自行选择服务的服务端。最后网络分区恢复时，Eureka服务端又可以通过异步数据同步，完成数据的最终一致。</p>
<p>在Eureka和Serf之间选择，考虑的主要是可扩展性，Serf的自动代理对接看似很有趣，每个Serf实例既是Client也是Server，但线上业务毕竟不是实验室，我们要考虑未来可能会有10万台服务器50万个服务实例，组成一个10万节点的Serf集群，对于Gossip协议一定是个不可完成的任务。而Eureka仅是将其Server聚簇，不会产生那么可怕的集群规模和广播流量。</p>
<p>最终我们还是选用Eureka，影响我们判断的主要是可用性和接入成本这两个因素。服务发现系统是一个可以放弃任何功能，唯独不能降低可用性要求的基础组件。</p>
<p>在部署架构方面，Eureka在可用性上做得如此完善，免去了我们几乎所有的可用性设计，我们只需要按官方建议的每个区域部署节点就行了，如图16-9所示。</p>
<p><img src="/images/15061698891530.jpg" alt=""></p>
<p>图16-9  部署架构示意图</p>
<h3 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h3><p>在介绍完所有需求分析和基础架构选型后，下面我们详细介绍一下之前提到的一些高级功能的设计和实现。</p>
<p><strong>1．层级化服务名字</strong><br>我们把名字设计为有序的，且具备层级，主要基于下面的一些考虑。<br>◎ 使用灵活，可使用任意层级的服务名字，获取其对应的位置信息。<br>◎ 和服务树规范定义的服务标识能够保持一致，具备设计继承性。在细节设计时，不需要将服务名字标识进行转化或对应。<br>◎ 层级化服务名字，是实现区域化解析和内部路由切换功能的核心基础。</p>
<p>服务发现系统的名字Tag，与服务树系统保持一致，详见“服务树”一节。<br>其层级顺序为：Job（作业）←JobGroup（作业组）←Service（服务）←ServiceGroup（服务组）←Pdl（产品线）←OWT（部门）←COP（公司）←Cluster（集群）。<br>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GetListByName(“cop.xiaomi_owt.miui_pdl.bbs_Service.php_job.php” “cop.xiaomi_owt.miui_pdl.bbs_Service.MYSQL_job.master”</div></pre></td></tr></table></figure>
<p>是指定查询MySQL主库的位置信息。</p>
<p>而</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GetListByName(“cop.xiaomi_owt.miui_pdl.bbs_Service.php_job.php” “cop.xiaomi_owt.miui_pdl.bbs_Service.MYSQL”</div></pre></td></tr></table></figure>
<p>则是指定查询MySQL的所有实例，包括Master和Slave。<br>这就是层级Tag的基础功能，根据不同层级的Tag，获取不同范围服务的位置信息。</p>
<p><strong>2．区域化解析</strong><br>为什么需要区域化解析呢？举个例子。我们有个线上业务，其架构是JobA需要访问本IDC机房的JobB，那么如何配置呢？是不是要根据实际部署情况，JobA部署到不同IDC时，要分别配置连接哪个IDC机房的JobB？新增加IDC机房时，还要新增加配置来适配？想想就很麻烦。</p>
<p>如果我们的服务发现系统有区域化解析功能，服务配置就会被简化：一个服务不必因部署到不同区域，而配置不同的服务名字。这个功能配合服务发现系统的域名区域化解析，就可以彻底做到让服务的配置和部署无关化，一个服务只需一个配置就可以部署到任意IDC机房，自动与本机房的关联服务对接，而无须人工关注太多。</p>
<p>我们可以类似这样使用：<br>GetListByName(“cop.xiaomi_owt.miui_pdl.bbs_Service.NGINX_job.NGINX” “cop.xiaomi_owt.miui_pdl.bbs_Service.php_job.php”<br>以上API调用，代表的含义是，主调方为cop.xiaomi_owt.miui_pdl.bbs_Service. NGINX_job.NGINX，要发现本机房的cop.xiaomi_owt.miui_pdl.bbs_Service.php_job.php这个job的位置信息，客户端会为两个jobname分别自动补齐cluster.IDC1，而Cluster这个信息取自于部署自动化系统为服务打上的标记.JOBNAME。</p>
<p>另外，也支持简单地指定Cluster域以明确使用某区域的该服务，这在如主库存在某一机房，或处于服务迁移阶段等场景下，很有实用价值。</p>
<p><strong>3．CNAME（内部路由切换和降级开关）</strong><br>CNAME功能是为动态路由切换设计的，我们可以提供轻量化的小工具，用来将某个服务的流量从某机房轻松调度到另一机房。这将为运维人员提供一种全新的预案手段，比域名切换更为精细化，带来的带宽、负载迁移也会更小。同时在机房频繁搬迁的场景中具有很大的价值，不必重新发布很多关联服务，才能将流量迁移走。</p>
<p>当CNAME字段设置为空时，服务发现API将直接返回空列表，应用服务进程会得到一个预定义的返回值，我们定义这个返回值为服务的降级开关，服务根据这个开关执行业务绕行、限流等逻辑。</p>
<p>我们提供API，可为任意级JobTag添加或删除CNAME字段，以提供“无痛”切换服务路由功能。例如：<br>SetCNAMEForName（name_tag, CNAME_tag）<br>UnsetCNAMEForName（name_tag）<br>当某个被调方服务的JobTag被设置了CNAME字段，任意主调方查询该服务的位置信息时，会自动改用CNAME_tag进行查询。为避免人为的使用混乱，不支持多次CNAME，以免造成CNAME成环等复杂问题。</p>
<p>UnsetCNAMEForName(name_tag)为服务名字删除CNAME字段，删除后恢复直接查询的逻辑。</p>
<p><strong>4．关系图谱</strong></p>
<p>前面提到过，在主调方调用服务查询API时，必须提供自身的JobTag。Eureka Client接到请求后，会自动将这次调用请求，通过旁路输出到一个汇聚解析服务。</p>
<p>汇聚解析服务将数据处理为符合建模要求的数据结构，导入Neo4j（一个专用图形数据库），然后通过Dashboard进行绘图展现。使用Neo4j提供的查询语句作为接口，以各级Tag为单位，绘制出服务间关联关系的图谱。也可以逐级展开，绘制出服务器级别的服务关系图谱。</p>
<p>通过服务关系图谱，研发和运维人员可以实时了解业务架构，更直观、清晰地了解服务之间的运行关系。在庞大而复杂的服务架构下，通过人工的方式理清服务之间的关系是完全不可能的，借助服务发现系统自动采集服务关系，更加的准确和实时。</p>
<p><strong>5．安全注册</strong></p>
<p>为了解决其他服务假冒身份注册到服务发现系统的安全问题，我们需要对服务实例注册的身份进行认证。要想认证某服务A的实例的身份是否伪造，我们需要有一个第三方认证中心，先由它为服务A颁发一对公私钥，私钥交给A，公钥认证中心留下。A的所有实例，在发起服务注册请求前，先向认证中心发起认证请求，认证请求即用私钥加密的一段密文，认证中心根据A声明的自己的身份，找到对应公钥进行解密，解密成功则认证通过。这时认证中心返回给A一个Access Token，A带着此Token请求服务注册中心，服务注册中心才允许其注册。整个请求示意图如图16-10所示。</p>
<p><img src="/images/15061699771658.jpg" alt=""></p>
<p>图16-10  服务注册请求示意图</p>
<p>与认证对应，还有一个问题需要解决，即授权，A服务是否允许B服务发起请求的问题。这个问题和服务发现无关，需要授权中心和A、B服务共同协作完成，所以在这里就不赘述了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在大规模复杂的系统中，每个服务是不是都具备自动服务发现能力，是考量整个系统架构是否具备可运维性的一个重要标尺。解决服务定位这个问题，从HardCode到HardConf，从HardConf到有服务发现系统，再到可以随意、灵活地路由，服务发现解决方案的演进，在相当程度上决定和体现着运维自动化水平的高低。</p>
<p>本章完整地介绍了在探索服务发现这个重要基础组件上，我们的演进状况和设计思路。本章介绍了一种对于绝大多数中小规模公司完全适用的，经历了近4年线上工程考验的服务发现系统解决方案；也介绍了一种我们正在尝试的新服务发现系统，希望能够尽快和读者分享我们的使用经验。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ღ ღ ღ 如果觉得文章对您有用，不妨打赏一下ღ ღ ღ</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.jpg" alt="于龙君 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.jpg" alt="于龙君 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      于龙君
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.yulongjun.com/under-the-ops/20170923-16-service-discovery/" title="第十六章：服务发现">http://www.yulongjun.com/under-the-ops/20170923-16-service-discovery/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Service-Discovery/" rel="tag"># Service Discovery</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/under-the-ops/20170923-15-it-service-management-platform/" rel="next" title="第十五章：服务管理平台">
                <i class="fa fa-chevron-left"></i> 第十五章：服务管理平台
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/under-the-ops/20170923-17-deploy-system/" rel="prev" title="第十七章：部署系统">
                第十七章：部署系统 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yODAzMy80NjA3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="于龙君" />
          <p class="site-author-name" itemprop="name">于龙君</p>
           
              <p class="site-description motion-element" itemprop="description">Linux, Python, macOS</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">224</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">281</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/yu-long-jun" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-quora"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1302333987" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/yulongjun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/__YuLongjun__" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.178linux.com/" title="Linux运维部落" target="_blank">Linux运维部落</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ttlsa.com/" title="运维生存时间" target="_blank">运维生存时间</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.sliverstack.com/" title="李恒的博客" target="_blank">李恒的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.qqlilin.com/" title="李林的博客" target="_blank">李林的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://vinnywang.com/" title="王楠的博客" target="_blank">王楠的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhaodaxin.com/" title="赵大鑫的博客" target="_blank">赵大鑫的博客</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://blog.whsir.com/" title="吴昊的博客" target="_blank">吴昊的博客</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#传统模式"><span class="nav-number">1.</span> <span class="nav-text">传统模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开源实现"><span class="nav-number"></span> <span class="nav-text">开源实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第一版设计"><span class="nav-number"></span> <span class="nav-text">第一版设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二版设计"><span class="nav-number"></span> <span class="nav-text">第二版设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#整体架构"><span class="nav-number">1.</span> <span class="nav-text">整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册中心选型"><span class="nav-number">2.</span> <span class="nav-text">注册中心选型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高级功能"><span class="nav-number">3.</span> <span class="nav-text">高级功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number"></span> <span class="nav-text">总结</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">于龙君</span>
</div>
<div>
  <a href="http://www.miitbeian.gov.cn/">京ICP备17049401号</a>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script>

  
  <script type="text/javascript" src="http://cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("xL6oGKp3T8SyrCjhb93y6RVx-gzGzoHsz", "HGXc2Np0bSets9V1GCOYz0f4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

</body>
</html>
